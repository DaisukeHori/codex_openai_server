<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codex API Server</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #fafafa;
      color: #111;
    }
    
    .app {
      height: 100%;
      display: flex;
    }
    
    /* Sidebar */
    .sidebar {
      width: 200px;
      background: #fff;
      border-right: 1px solid #e5e5e5;
      padding: 30px 0;
      display: flex;
      flex-direction: column;
    }
    
    .logo {
      padding: 0 24px 30px;
      font-size: 14px;
      font-weight: 600;
      color: #111;
      letter-spacing: -0.3px;
    }
    
    .nav {
      flex: 1;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      font-size: 13px;
      color: #888;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 2px solid transparent;
    }
    
    .nav-item:hover {
      color: #111;
      background: #fafafa;
    }
    
    .nav-item.active {
      color: #111;
      background: #fafafa;
      border-left-color: #111;
    }
    
    .nav-item.done {
      color: #22c55e;
    }
    
    .nav-num {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #e5e5e5;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 500;
    }
    
    .nav-item.active .nav-num {
      background: #111;
      color: #fff;
    }
    
    .nav-item.done .nav-num {
      background: #22c55e;
      color: #fff;
    }
    
    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .header {
      padding: 30px 40px 0;
    }
    
    .header h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.3px;
      margin-bottom: 6px;
    }
    
    .header p {
      font-size: 13px;
      color: #666;
    }
    
    .body {
      flex: 1;
      padding: 30px 40px;
      overflow-y: auto;
    }
    
    .footer {
      padding: 20px 40px;
      border-top: 1px solid #e5e5e5;
      background: #fff;
      display: flex;
      justify-content: space-between;
    }
    
    /* Steps */
    .step {
      display: none;
      height: 100%;
      flex-direction: column;
    }
    
    .step.active {
      display: flex;
    }
    
    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }
    
    .btn-primary {
      background: #111;
      color: #fff;
      border-color: #111;
    }
    
    .btn-primary:hover {
      background: #333;
    }
    
    .btn-secondary {
      background: #fff;
      color: #111;
      border-color: #ddd;
    }
    
    .btn-secondary:hover {
      background: #fafafa;
      border-color: #ccc;
    }
    
    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    /* Cards */
    .card {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 12px;
    }
    
    /* Feature grid */
    .features {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .feature {
      padding: 16px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
    }
    
    .feature-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .feature-desc {
      font-size: 12px;
      color: #666;
    }
    
    /* Status */
    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .status-row:last-child {
      border-bottom: none;
    }
    
    .status-label {
      font-size: 13px;
      color: #666;
    }
    
    .status-value {
      font-size: 13px;
      font-weight: 500;
    }
    
    .status-ok { color: #22c55e; }
    .status-warn { color: #f59e0b; }
    .status-error { color: #ef4444; }
    
    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
      transition: border-color 0.15s;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #111;
    }
    
    .input-row {
      display: flex;
      gap: 8px;
    }
    
    .input-row .form-input {
      flex: 1;
    }
    
    .form-hint {
      font-size: 12px;
      color: #888;
      margin-top: 6px;
    }
    
    /* Complete */
    .complete-icon {
      width: 48px;
      height: 48px;
      background: #22c55e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .complete-icon svg {
      width: 24px;
      height: 24px;
      stroke: #fff;
      stroke-width: 3;
      fill: none;
    }
    
    .summary {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    
    .summary-item {
      padding: 16px;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
    }
    
    .summary-label {
      font-size: 11px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .summary-value {
      font-size: 14px;
      font-weight: 500;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    /* Action buttons */
    .actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    /* Install progress */
    .install-progress {
      margin-top: 12px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, Consolas, monospace;
      font-size: 11px;
      max-height: 120px;
      overflow-y: auto;
      display: none;
    }

    .install-progress.visible {
      display: block;
    }

    .install-progress .log-line {
      color: #666;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .btn-installing {
      opacity: 0.7;
      cursor: wait;
    }

    .spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-right: 6px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo">Codex API Server</div>
      <nav class="nav">
        <div class="nav-item active" data-step="1">
          <span class="nav-num">1</span>
          <span>はじめに</span>
        </div>
        <div class="nav-item" data-step="2">
          <span class="nav-num">2</span>
          <span>LLMプロバイダー</span>
        </div>
        <div class="nav-item" data-step="3">
          <span class="nav-num">3</span>
          <span>マスターキー</span>
        </div>
        <div class="nav-item" data-step="4">
          <span class="nav-num">4</span>
          <span>ポート設定</span>
        </div>
        <div class="nav-item" data-step="5">
          <span class="nav-num">5</span>
          <span>完了</span>
        </div>
      </nav>
    </div>
    
    <!-- Main content -->
    <div class="main">
      <!-- Step 1 -->
      <div class="step active" data-step="1">
        <div class="header">
          <h1>はじめに</h1>
          <p>OpenAI API互換サーバーをセットアップします</p>
        </div>
        <div class="body">
          <div class="features">
            <div class="feature">
              <div class="feature-title">API互換</div>
              <div class="feature-desc">OpenAI APIと完全互換のエンドポイント</div>
            </div>
            <div class="feature">
              <div class="feature-title">マルチテナント</div>
              <div class="feature-desc">複数のAPIキーを発行・管理</div>
            </div>
            <div class="feature">
              <div class="feature-title">トンネル</div>
              <div class="feature-desc">Cloudflareで外部公開</div>
            </div>
            <div class="feature">
              <div class="feature-title">使用量追跡</div>
              <div class="feature-desc">キーごとの利用状況を記録</div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div></div>
          <button class="btn btn-primary" onclick="goToStep(2)">次へ</button>
        </div>
      </div>
      
      <!-- Step 2 -->
      <div class="step" data-step="2">
        <div class="header">
          <h1>LLMプロバイダー</h1>
          <p>Codex CLI または Claude CLI のいずれかの認証を完了してください</p>
        </div>
        <div class="body" style="display: flex; gap: 20px; flex-wrap: wrap;">
          <!-- Codex CLI -->
          <div class="card" style="flex: 1; min-width: 280px;">
            <h3 style="margin-bottom: 15px; font-size: 16px;">OpenAI Codex CLI</h3>
            <div class="status-row">
              <span class="status-label">インストール</span>
              <span id="codex-installed" class="status-value">確認中...</span>
            </div>
            <div class="status-row">
              <span class="status-label">認証</span>
              <span id="codex-auth" class="status-value">確認中...</span>
            </div>
            <div class="status-row">
              <span class="status-label">バージョン</span>
              <span id="codex-version" class="status-value">-</span>
            </div>
            <div class="actions" id="codex-actions" style="display:none; margin-top: 15px;">
              <button class="btn btn-primary" onclick="installCodex()" id="codex-install-btn" style="display:none;">
                <span class="btn-text">インストール</span>
              </button>
              <button class="btn btn-secondary" onclick="authCodex()" id="codex-auth-btn" style="display:none;">認証する</button>
              <button class="btn btn-secondary" onclick="checkProviders()" id="codex-refresh-btn">再確認</button>
            </div>
            <div class="install-progress" id="codex-progress"></div>
          </div>

          <!-- Claude CLI -->
          <div class="card" style="flex: 1; min-width: 280px;">
            <h3 style="margin-bottom: 15px; font-size: 16px;">Anthropic Claude CLI</h3>
            <div class="status-row">
              <span class="status-label">インストール</span>
              <span id="claude-installed" class="status-value">確認中...</span>
            </div>
            <div class="status-row">
              <span class="status-label">認証</span>
              <span id="claude-auth" class="status-value">確認中...</span>
            </div>
            <div class="status-row">
              <span class="status-label">バージョン</span>
              <span id="claude-version" class="status-value">-</span>
            </div>
            <div class="actions" id="claude-actions" style="display:none; margin-top: 15px;">
              <button class="btn btn-primary" onclick="installClaudeCLI()" id="claude-install-btn" style="display:none;">
                <span class="btn-text">インストール</span>
              </button>
              <button class="btn btn-secondary" onclick="checkProviders()" id="claude-refresh-btn">再確認</button>
            </div>
            <div class="install-progress" id="claude-progress"></div>
          </div>
        </div>
        <p id="provider-status" style="text-align: center; margin-top: 15px; color: #888;"></p>
        <div class="footer">
          <button class="btn btn-secondary" onclick="goToStep(1)">戻る</button>
          <button class="btn btn-primary" onclick="goToStep(3)" id="step2-next" disabled>次へ</button>
        </div>
      </div>
      
      <!-- Step 3 -->
      <div class="step" data-step="3">
        <div class="header">
          <h1>マスターキー</h1>
          <p>管理用のマスターキーを生成します</p>
        </div>
        <div class="body">
          <div class="form-group">
            <label class="form-label">マスターキー</label>
            <div class="input-row">
              <input type="text" class="form-input" id="master-key" readonly placeholder="生成ボタンを押してください">
              <button class="btn btn-secondary" onclick="generateKey()">生成</button>
            </div>
            <p class="form-hint">このキーは管理操作に必要です。安全に保管してください。</p>
          </div>
        </div>
        <div class="footer">
          <button class="btn btn-secondary" onclick="goToStep(2)">戻る</button>
          <button class="btn btn-primary" onclick="goToStep(4)" id="step3-next" disabled>次へ</button>
        </div>
      </div>
      
      <!-- Step 4 -->
      <div class="step" data-step="4">
        <div class="header">
          <h1>ポート設定</h1>
          <p>サーバーが使用するポート番号を指定します</p>
        </div>
        <div class="body">
          <div class="form-group">
            <label class="form-label">ポート番号</label>
            <input type="number" class="form-input" id="port" value="8080" min="1024" max="65535" style="max-width:200px;">
            <p class="form-hint">1024〜65535の範囲。既定は8080です。</p>
          </div>
          <div class="card">
            <div class="status-row">
              <span class="status-label">アクセスURL</span>
              <span class="status-value" id="access-url">http://localhost:8080</span>
            </div>
          </div>
        </div>
        <div class="footer">
          <button class="btn btn-secondary" onclick="goToStep(3)">戻る</button>
          <button class="btn btn-primary" onclick="goToStep(5)">次へ</button>
        </div>
      </div>
      
      <!-- Step 5 -->
      <div class="step" data-step="5">
        <div class="header">
          <h1>セットアップ完了</h1>
          <p>サーバーを起動する準備ができました</p>
        </div>
        <div class="body">
          <div class="complete-icon">
            <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
          </div>
          <div class="summary">
            <div class="summary-item">
              <div class="summary-label">ポート</div>
              <div class="summary-value" id="summary-port">8080</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">マスターキー</div>
              <div class="summary-value" id="summary-key">-</div>
            </div>
          </div>
        </div>
        <div class="footer">
          <button class="btn btn-secondary" onclick="goToStep(4)">戻る</button>
          <button class="btn btn-primary" onclick="completeSetup()">サーバーを起動</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 1;
    
    function goToStep(step) {
      // Update steps
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
      
      // Update nav
      document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.remove('active');
        if (i + 1 < step) item.classList.add('done');
        else item.classList.remove('done');
        if (i + 1 === step) item.classList.add('active');
      });
      
      currentStep = step;

      if (step === 2) checkProviders();
      if (step === 5) updateSummary();
    }

    // LLM Providers
    let codexStatus = null;
    let claudeStatus = null;
    let installingCodex = false;
    let installingClaude = false;

    // Set up install progress listener
    window.electronAPI.onInstallProgress((data) => {
      const progressEl = document.getElementById(`${data.provider}-progress`);
      if (progressEl) {
        progressEl.classList.add('visible');
        const line = document.createElement('div');
        line.className = 'log-line';
        line.textContent = data.message.trim();
        progressEl.appendChild(line);
        progressEl.scrollTop = progressEl.scrollHeight;
      }
    });

    async function checkProviders() {
      try {
        // Check both providers in parallel
        const [codex, claude] = await Promise.all([
          window.electronAPI.getCodexStatus().catch(() => ({ installed: false, authenticated: false })),
          window.electronAPI.getClaudeStatus().catch(() => ({ installed: false, authenticated: false }))
        ]);

        codexStatus = codex;
        claudeStatus = claude;

        // Update Codex UI
        document.getElementById('codex-installed').textContent = codex.installed ? '完了' : '未インストール';
        document.getElementById('codex-installed').className = 'status-value ' + (codex.installed ? 'status-ok' : 'status-error');
        document.getElementById('codex-auth').textContent = codex.authenticated ? '完了' : '未認証';
        document.getElementById('codex-auth').className = 'status-value ' + (codex.authenticated ? 'status-ok' : 'status-warn');
        document.getElementById('codex-version').textContent = codex.version || '-';
        document.getElementById('codex-actions').style.display = 'flex';
        document.getElementById('codex-install-btn').style.display = codex.installed ? 'none' : 'block';
        document.getElementById('codex-auth-btn').style.display = (codex.installed && !codex.authenticated) ? 'block' : 'none';

        // Update Claude UI
        document.getElementById('claude-installed').textContent = claude.installed ? '完了' : '未インストール';
        document.getElementById('claude-installed').className = 'status-value ' + (claude.installed ? 'status-ok' : 'status-error');
        document.getElementById('claude-auth').textContent = claude.authenticated ? '完了' : '未認証';
        document.getElementById('claude-auth').className = 'status-value ' + (claude.authenticated ? 'status-ok' : 'status-warn');
        document.getElementById('claude-version').textContent = claude.version || '-';
        document.getElementById('claude-actions').style.display = 'flex';
        document.getElementById('claude-install-btn').style.display = claude.installed ? 'none' : 'block';

        // Enable next button if at least one provider is authenticated
        const anyAuthenticated = codex.authenticated || claude.authenticated;
        document.getElementById('step2-next').disabled = !anyAuthenticated;

        // Update status message
        const statusEl = document.getElementById('provider-status');
        if (anyAuthenticated) {
          const providers = [];
          if (codex.authenticated) providers.push('Codex');
          if (claude.authenticated) providers.push('Claude');
          statusEl.textContent = `✓ ${providers.join(' と ')} が利用可能です`;
          statusEl.style.color = '#10b981';
        } else {
          statusEl.textContent = 'いずれかのプロバイダーを認証してください';
          statusEl.style.color = '#f59e0b';
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function installCodex() {
      if (installingCodex) return;
      installingCodex = true;

      const btn = document.getElementById('codex-install-btn');
      const progressEl = document.getElementById('codex-progress');

      // Show installing state
      btn.classList.add('btn-installing');
      btn.innerHTML = '<span class="spinner"></span>インストール中...';
      btn.disabled = true;
      progressEl.innerHTML = '';
      progressEl.classList.add('visible');

      try {
        const result = await window.electronAPI.installCodex();

        if (result.success) {
          const line = document.createElement('div');
          line.className = 'log-line';
          line.style.color = '#10b981';
          line.textContent = '✓ ' + result.message;
          progressEl.appendChild(line);

          // Re-check status after successful install
          setTimeout(checkProviders, 1000);
        } else {
          const line = document.createElement('div');
          line.className = 'log-line';
          line.style.color = '#ef4444';
          line.textContent = '✗ ' + result.message;
          progressEl.appendChild(line);

          // Reset button
          btn.classList.remove('btn-installing');
          btn.innerHTML = '<span class="btn-text">インストール</span>';
          btn.disabled = false;
        }
      } catch (e) {
        const line = document.createElement('div');
        line.className = 'log-line';
        line.style.color = '#ef4444';
        line.textContent = '✗ エラー: ' + e.message;
        progressEl.appendChild(line);

        btn.classList.remove('btn-installing');
        btn.innerHTML = '<span class="btn-text">インストール</span>';
        btn.disabled = false;
      }

      installingCodex = false;
    }

    async function installClaudeCLI() {
      if (installingClaude) return;
      installingClaude = true;

      const btn = document.getElementById('claude-install-btn');
      const progressEl = document.getElementById('claude-progress');

      // Show installing state
      btn.classList.add('btn-installing');
      btn.innerHTML = '<span class="spinner"></span>インストール中...';
      btn.disabled = true;
      progressEl.innerHTML = '';
      progressEl.classList.add('visible');

      try {
        const result = await window.electronAPI.installClaude();

        if (result.success) {
          const line = document.createElement('div');
          line.className = 'log-line';
          line.style.color = '#10b981';
          line.textContent = '✓ ' + result.message;
          progressEl.appendChild(line);

          // Re-check status after successful install
          setTimeout(checkProviders, 1000);
        } else {
          const line = document.createElement('div');
          line.className = 'log-line';
          line.style.color = '#ef4444';
          line.textContent = '✗ ' + result.message;
          progressEl.appendChild(line);

          // Reset button
          btn.classList.remove('btn-installing');
          btn.innerHTML = '<span class="btn-text">インストール</span>';
          btn.disabled = false;
        }
      } catch (e) {
        const line = document.createElement('div');
        line.className = 'log-line';
        line.style.color = '#ef4444';
        line.textContent = '✗ エラー: ' + e.message;
        progressEl.appendChild(line);

        btn.classList.remove('btn-installing');
        btn.innerHTML = '<span class="btn-text">インストール</span>';
        btn.disabled = false;
      }

      installingClaude = false;
    }

    async function authCodex() {
      await window.electronAPI.runCodexAuth();
      setTimeout(checkProviders, 2000);
    }
    
    // Key
    async function generateKey() {
      const key = await window.electronAPI.generateMasterKey();
      document.getElementById('master-key').value = key;
      document.getElementById('step3-next').disabled = false;
    }
    
    // Port
    document.getElementById('port').addEventListener('input', function() {
      document.getElementById('access-url').textContent = 'http://localhost:' + this.value;
    });
    
    // Summary
    function updateSummary() {
      document.getElementById('summary-port').textContent = document.getElementById('port').value;
      const key = document.getElementById('master-key').value;
      document.getElementById('summary-key').textContent = key ? key.substring(0, 12) + '...' : '-';
    }
    
    // Complete
    async function completeSetup() {
      const port = parseInt(document.getElementById('port').value);
      const masterKey = document.getElementById('master-key').value;
      
      await window.electronAPI.setConfig('port', port);
      await window.electronAPI.setConfig('masterKey', masterKey);
      await window.electronAPI.completeOnboarding();
    }
    
    // Init
    (async () => {
      try {
        const config = await window.electronAPI.getConfig();
        if (config.masterKey) {
          document.getElementById('master-key').value = config.masterKey;
          document.getElementById('step3-next').disabled = false;
        }
        if (config.port) {
          document.getElementById('port').value = config.port;
          document.getElementById('access-url').textContent = 'http://localhost:' + config.port;
        }
      } catch (e) {}
    })();
  </script>
</body>
</html>
