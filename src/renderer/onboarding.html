<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;">
  <title>Codex API Server - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1f2937;
    }
    .container {
      background: white;
      border-radius: 24px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 600px;
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 32px;
      text-align: center;
    }
    .header h1 { font-size: 28px; font-weight: 700; }
    .header p { margin-top: 8px; opacity: 0.9; }
    .progress {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 24px;
    }
    .progress-step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transition: all 0.3s;
    }
    .progress-step.active { background: white; transform: scale(1.2); }
    .progress-step.done { background: #10b981; }
    .content {
      padding: 40px;
      min-height: 350px;
      display: flex;
      flex-direction: column;
    }
    .step { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.3s; }
    .step.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .step-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .step-desc { color: #6b7280; margin-bottom: 24px; line-height: 1.6; }
    .icon-container {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      font-size: 36px;
    }
    .icon-purple { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
    .icon-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .icon-blue { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
    .icon-orange { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 8px; }
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.2s;
    }
    .form-group input:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
    .key-display {
      background: #f3f4f6;
      padding: 16px;
      border-radius: 12px;
      font-family: monospace;
      font-size: 14px;
      word-break: break-all;
      margin-bottom: 16px;
    }
    .status-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .status-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .status-item:last-child { border-bottom: none; }
    .status-label { color: #6b7280; }
    .status-value { font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .status-ok { background: #10b981; }
    .status-error { background: #ef4444; }
    .status-pending { background: #f59e0b; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .buttons {
      display: flex;
      gap: 12px;
      margin-top: auto;
      padding-top: 24px;
    }
    .btn {
      flex: 1;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { background: #f3f4f6; color: #4b5563; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .help-text { font-size: 14px; color: #6b7280; margin-top: 8px; }
    .success-animation {
      text-align: center;
      padding: 40px 0;
    }
    .success-icon {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 48px;
      animation: scaleIn 0.5s ease-out;
    }
    @keyframes scaleIn { from { transform: scale(0); } to { transform: scale(1); } }
    .feature-list {
      text-align: left;
      margin: 24px 0;
    }
    .feature-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      color: #374151;
    }
    .feature-item::before {
      content: 'âœ“';
      width: 24px;
      height: 24px;
      background: #10b981;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ Codex API Server</h1>
      <p>ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰</p>
      <div class="progress">
        <div class="progress-step active" data-step="1"></div>
        <div class="progress-step" data-step="2"></div>
        <div class="progress-step" data-step="3"></div>
        <div class="progress-step" data-step="4"></div>
        <div class="progress-step" data-step="5"></div>
      </div>
    </div>
    
    <div class="content">
      <!-- Step 1: Welcome -->
      <div class="step active" data-step="1">
        <div class="icon-container icon-purple">ğŸ‘‹</div>
        <h2 class="step-title">ã‚ˆã†ã“ãï¼</h2>
        <p class="step-desc">
          Codex API Serverã¯ã€OpenAI APIã¨äº’æ›æ€§ã®ã‚ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚
          ã“ã®ã‚¦ã‚£ã‚¶ãƒ¼ãƒ‰ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ã„å§‹ã‚ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
        </p>
        <div class="feature-list">
          <div class="feature-item">OpenAI Responses API å®Œå…¨äº’æ›</div>
          <div class="feature-item">Chat Completions API ã‚µãƒãƒ¼ãƒˆ</div>
          <div class="feature-item">ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆAPIã‚­ãƒ¼ç®¡ç†</div>
          <div class="feature-item">Cloudflare Tunnelã§å³åº§ã«å…¬é–‹</div>
        </div>
        <div class="buttons">
          <button class="btn btn-primary" onclick="nextStep()">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ â†’</button>
        </div>
      </div>
      
      <!-- Step 2: Codex CLI Check -->
      <div class="step" data-step="2">
        <div class="icon-container icon-blue">ğŸ”§</div>
        <h2 class="step-title">Codex CLI ç¢ºèª</h2>
        <p class="step-desc">
          Codex CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹ã¨èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™ã€‚
        </p>
        <div class="status-box">
          <div class="status-item">
            <span class="status-label">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹</span>
            <span class="status-value" id="codex-installed">
              <span class="status-dot status-pending"></span>
              ç¢ºèªä¸­...
            </span>
          </div>
          <div class="status-item">
            <span class="status-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
            <span class="status-value" id="codex-version">-</span>
          </div>
          <div class="status-item">
            <span class="status-label">èªè¨¼çŠ¶æ…‹</span>
            <span class="status-value" id="codex-auth">
              <span class="status-dot status-pending"></span>
              ç¢ºèªä¸­...
            </span>
          </div>
        </div>
        <p class="help-text" id="codex-help"></p>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="prevStep()">â† æˆ»ã‚‹</button>
          <button class="btn btn-primary" id="codex-next" onclick="nextStep()" disabled>æ¬¡ã¸ â†’</button>
        </div>
      </div>
      
      <!-- Step 3: Master Key -->
      <div class="step" data-step="3">
        <div class="icon-container icon-orange">ğŸ”‘</div>
        <h2 class="step-title">ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼è¨­å®š</h2>
        <p class="step-desc">
          ç®¡ç†ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¨APIã‚­ãƒ¼ç®¡ç†ã«ä½¿ç”¨ã™ã‚‹ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
        </p>
        <div class="form-group">
          <label>ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼</label>
          <input type="text" id="master-key" placeholder="è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™" readonly>
        </div>
        <button class="btn btn-secondary" onclick="generateKey()" style="margin-bottom: 16px;">
          ğŸ”„ æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆ
        </button>
        <p class="help-text">
          âš ï¸ ã“ã®ã‚­ãƒ¼ã¯å®‰å…¨ãªå ´æ‰€ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚ç®¡ç†ç”»é¢ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã«å¿…è¦ã§ã™ã€‚
        </p>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="prevStep()">â† æˆ»ã‚‹</button>
          <button class="btn btn-primary" onclick="saveMasterKey()">æ¬¡ã¸ â†’</button>
        </div>
      </div>
      
      <!-- Step 4: Port Setting -->
      <div class="step" data-step="4">
        <div class="icon-container icon-green">ğŸŒ</div>
        <h2 class="step-title">ã‚µãƒ¼ãƒãƒ¼è¨­å®š</h2>
        <p class="step-desc">
          ã‚µãƒ¼ãƒãƒ¼ã®å¾…ã¡å—ã‘ãƒãƒ¼ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
        </p>
        <div class="form-group">
          <label>ãƒãƒ¼ãƒˆç•ªå·</label>
          <input type="number" id="port" value="8080" min="1" max="65535">
        </div>
        <p class="help-text">
          ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯8080ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç«¶åˆã™ã‚‹å ´åˆã¯å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
        </p>
        <div class="buttons">
          <button class="btn btn-secondary" onclick="prevStep()">â† æˆ»ã‚‹</button>
          <button class="btn btn-primary" onclick="savePort()">æ¬¡ã¸ â†’</button>
        </div>
      </div>
      
      <!-- Step 5: Complete -->
      <div class="step" data-step="5">
        <div class="success-animation">
          <div class="success-icon">âœ“</div>
          <h2 class="step-title">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼</h2>
          <p class="step-desc">
            Codex API Serverã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚
            ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ä½¿ã„å§‹ã‚ã¾ã—ã‚‡ã†ï¼
          </p>
        </div>
        <div class="status-box">
          <div class="status-item">
            <span class="status-label">ã‚µãƒ¼ãƒãƒ¼URL</span>
            <span class="status-value" id="final-url">http://localhost:8080</span>
          </div>
          <div class="status-item">
            <span class="status-label">ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼</span>
            <span class="status-value" id="final-key" style="font-family: monospace; font-size: 12px;">msk_xxx...</span>
          </div>
        </div>
        <div class="buttons">
          <button class="btn btn-success" onclick="completeSetup()" id="complete-btn">
            ğŸš€ ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let currentStep = 1;
    const totalSteps = 5;
    
    // Update progress indicators
    function updateProgress() {
      document.querySelectorAll('.progress-step').forEach((el, i) => {
        el.classList.remove('active', 'done');
        if (i + 1 < currentStep) el.classList.add('done');
        if (i + 1 === currentStep) el.classList.add('active');
      });
      
      document.querySelectorAll('.step').forEach((el, i) => {
        el.classList.toggle('active', i + 1 === currentStep);
      });
    }
    
    function nextStep() {
      if (currentStep < totalSteps) {
        currentStep++;
        updateProgress();
        onStepEnter(currentStep);
      }
    }
    
    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateProgress();
      }
    }
    
    async function onStepEnter(step) {
      if (step === 2) {
        await checkCodexStatus();
      } else if (step === 3) {
        await generateKey();
      } else if (step === 5) {
        updateFinalSummary();
      }
    }
    
    async function checkCodexStatus() {
      try {
        const status = await window.electronAPI.getCodexStatus();
        
        const installedEl = document.getElementById('codex-installed');
        const versionEl = document.getElementById('codex-version');
        const authEl = document.getElementById('codex-auth');
        const helpEl = document.getElementById('codex-help');
        const nextBtn = document.getElementById('codex-next');
        
        if (status.installed) {
          installedEl.innerHTML = '<span class="status-dot status-ok"></span>ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿';
          versionEl.textContent = status.version || 'Unknown';
          
          if (status.authenticated) {
            authEl.innerHTML = '<span class="status-dot status-ok"></span>èªè¨¼æ¸ˆã¿ (' + (status.authMethod === 'chatgpt' ? 'ChatGPT' : 'APIã‚­ãƒ¼') + ')';
            nextBtn.disabled = false;
            helpEl.textContent = 'âœ“ Codex CLIã¯æ­£å¸¸ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚';
          } else {
            authEl.innerHTML = '<span class="status-dot status-error"></span>æœªèªè¨¼';
            helpEl.innerHTML = 'âŒ Codex CLIã®èªè¨¼ãŒå¿…è¦ã§ã™ã€‚ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ <code>codex auth</code> ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
            nextBtn.disabled = true;
          }
        } else {
          installedEl.innerHTML = '<span class="status-dot status-error"></span>æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
          helpEl.innerHTML = 'âŒ Codex CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br><code>npm i -g @openai/codex</code> ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚';
          nextBtn.disabled = true;
        }
      } catch (error) {
        console.error('Error checking codex status:', error);
      }
    }
    
    async function generateKey() {
      try {
        const key = await window.electronAPI.generateMasterKey();
        document.getElementById('master-key').value = key;
      } catch (error) {
        console.error('Error generating key:', error);
      }
    }
    
    async function saveMasterKey() {
      const key = document.getElementById('master-key').value;
      if (!key) {
        alert('ãƒã‚¹ã‚¿ãƒ¼ã‚­ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
        return;
      }
      await window.electronAPI.setConfig('masterKey', key);
      nextStep();
    }
    
    async function savePort() {
      const port = parseInt(document.getElementById('port').value);
      if (isNaN(port) || port < 1 || port > 65535) {
        alert('æœ‰åŠ¹ãªãƒãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (1-65535)');
        return;
      }
      await window.electronAPI.setConfig('port', port);
      nextStep();
    }
    
    async function updateFinalSummary() {
      const config = await window.electronAPI.getConfig();
      document.getElementById('final-url').textContent = `http://localhost:${config.port}`;
      document.getElementById('final-key').textContent = config.masterKey.slice(0, 12) + '...';
    }
    
    async function completeSetup() {
      const btn = document.getElementById('complete-btn');
      btn.innerHTML = '<span class="spinner"></span>èµ·å‹•ä¸­...';
      btn.disabled = true;
      
      try {
        // Start server
        const result = await window.electronAPI.startServer();
        
        if (result.running) {
          // Complete onboarding
          await window.electronAPI.completeOnboarding();
        } else {
          alert('ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.error || 'Unknown error'));
          btn.innerHTML = 'ğŸš€ ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•';
          btn.disabled = false;
        }
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        btn.innerHTML = 'ğŸš€ ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•';
        btn.disabled = false;
      }
    }
    
    // Initialize
    updateProgress();
  </script>
</body>
</html>
