<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com; connect-src 'self' http://localhost:*;">
  <title>Codex ClaudeCode API Server - 管理コンソール</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #fafafa;
      color: #111;
    }

    code, .mono { font-family: 'SF Mono', Consolas, monospace; font-size: 13px; }

    /* CSS Variables - Minimal theme */
    :root {
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f5f5f5;
      --text-primary: #111;
      --text-secondary: #666;
      --text-muted: #888;
      --border: #e5e5e5;
      --accent: #111;
      --accent-hover: #333;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    body { background: var(--bg-primary); color: var(--text-primary); }

    /* Card - Simple border style */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    /* Sidebar - Light style like onboarding */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
    }

    .sidebar-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      margin: 2px 8px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
      border-radius: 6px;
      border-left: 2px solid transparent;
    }

    .sidebar-item:hover {
      color: var(--text-primary);
      background: var(--bg-tertiary);
    }

    .sidebar-item.active {
      color: var(--text-primary);
      background: var(--bg-tertiary);
      border-left-color: var(--accent);
    }

    /* Input fields */
    .input-field {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: border-color 0.15s;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Buttons - Simple solid style */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
      border-color: #ccc;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
      border-color: var(--danger);
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    .btn-success {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Badges - Simple style */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #e0e7ff; color: #3730a3; }
    .badge-purple { background: #f3e8ff; color: #6b21a8; }

    /* Status dots */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-online { background: var(--success); }
    .status-offline { background: var(--danger); }

    /* Table rows */
    .table-row { transition: background 0.1s; }
    .table-row:hover { background: var(--bg-tertiary); }

    /* Key blur */
    .key-blur { filter: blur(4px); transition: filter 0.15s; }
    .key-blur:hover { filter: blur(0); }

    /* Log lines */
    .log-line { font-size: 12px; padding: 6px 10px; border-radius: 4px; margin: 2px 0; }
    .log-info { background: #eff6ff; border-left: 2px solid #3b82f6; }
    .log-success { background: #f0fdf4; border-left: 2px solid #22c55e; }
    .log-warning { background: #fffbeb; border-left: 2px solid #f59e0b; }
    .log-error { background: #fef2f2; border-left: 2px solid #ef4444; }

    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 22px;
      background: var(--border);
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active { background: var(--accent); }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .toggle-switch.active::after { transform: translateX(22px); }

    /* Scrollbar */
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: var(--bg-tertiary); }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

    /* Simple animations */
    .animate-fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Notification badge */
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 16px;
      height: 16px;
      background: var(--danger);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar-mobile-hidden { transform: translateX(-100%); }
      .sidebar-mobile-visible { transform: translateX(0); }
    }

    /* Checkbox row */
    .checkbox-row { transition: background 0.1s; }
    .checkbox-row:hover { background: var(--bg-tertiary); }
    .checkbox-row.selected { background: #f0f9ff; }

    /* Gradient classes removed - using solid colors instead */
    .gradient-primary { background: var(--accent); }
    .gradient-success { background: var(--success); }
    .gradient-warning { background: var(--warning); }
    .gradient-danger { background: var(--danger); }

    /* Update Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      animation: fadeIn 0.2s ease-out;
    }
    .modal-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      max-width: 480px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Progress bar */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }

    /* Release notes content styling */
    .release-notes-content h2 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 0.5rem 0;
      color: var(--text-primary);
    }
    .release-notes-content h3 {
      font-size: 0.875rem;
      font-weight: 600;
      margin: 0.75rem 0 0.25rem 0;
      color: var(--text-primary);
    }
    .release-notes-content p {
      margin: 0.25rem 0;
    }
    .release-notes-content ul, .release-notes-content ol {
      margin: 0.25rem 0;
      padding-left: 1.25rem;
    }
    .release-notes-content li {
      margin: 0.125rem 0;
    }
    .release-notes-content code {
      background: var(--bg-secondary);
      padding: 0.125rem 0.25rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo, createContext, useContext } = React;

    // ============================================
    // Context & Theme
    // ============================================
    const ThemeContext = createContext();
    const useTheme = () => useContext(ThemeContext);

    const ThemeProvider = ({ children }) => {
      const [dark, setDark] = useState(() => localStorage.getItem('theme') === 'dark');
      useEffect(() => {
        document.documentElement.classList.toggle('dark', dark);
        localStorage.setItem('theme', dark ? 'dark' : 'light');
      }, [dark]);
      return <ThemeContext.Provider value={{ dark, setDark, toggle: () => setDark(d => !d) }}>{children}</ThemeContext.Provider>;
    };

    // ============================================
    // Icons
    // ============================================
    const Icons = {
      Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>,
      Key: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" /></svg>,
      History: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      Terminal: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
      Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      Chart: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      Log: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
      Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      Refresh: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
      Copy: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
      Check: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      Update: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
      Download: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
      Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
      Ban: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>,
      Activity: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
      Server: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" /></svg>,
      Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
      Moon: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
      Sun: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
      Download: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      Play: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
      CheckSquare: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    };

    // ============================================
    // API Client (No authentication required)
    // ============================================
    const createApi = (baseUrl) => {
      const headers = { 'Content-Type': 'application/json' };
      const handle = async (res) => {
        console.log('[API] Response status:', res.status, 'ok:', res.ok);
        if (!res.ok) {
          const text = await res.text();
          console.error('[API] Error response:', text);
          throw new Error(text);
        }
        const json = await res.json();
        console.log('[API] Response JSON:', json);
        return json;
      };
      return {
        health: (refresh = false) => fetch(`${baseUrl}/health${refresh ? '?refresh=true' : ''}`).then(handle),
        processStatus: () => fetch(`${baseUrl}/status/processes`, { headers }).then(handle),
        listKeys: (inactive = false) => fetch(`${baseUrl}/v1/api-keys?include_inactive=${inactive}`, { headers }).then(handle),
        getKey: (id) => fetch(`${baseUrl}/v1/api-keys/${id}`, { headers }).then(handle),
        createKey: (data) => fetch(`${baseUrl}/v1/api-keys`, { method: 'POST', headers, body: JSON.stringify(data) }).then(handle),
        updateKey: (id, data) => fetch(`${baseUrl}/v1/api-keys/${id}`, { method: 'PATCH', headers, body: JSON.stringify(data) }).then(handle),
        revokeKey: (id) => fetch(`${baseUrl}/v1/api-keys/${id}/revoke`, { method: 'POST', headers }).then(handle),
        deleteKey: (id) => fetch(`${baseUrl}/v1/api-keys/${id}`, { method: 'DELETE', headers }).then(handle),
        getUsage: (id, start, end) => {
          let url = `${baseUrl}/v1/api-keys/${id}/usage`;
          const p = new URLSearchParams();
          if (start) p.append('start_date', start);
          if (end) p.append('end_date', end);
          if (p.toString()) url += `?${p}`;
          return fetch(url, { headers }).then(handle);
        },
        getStats: () => fetch(`${baseUrl}/v1/api-keys-stats`, { headers }).then(handle),
        listResponses: (limit = 50) => fetch(`${baseUrl}/v1/responses?limit=${limit}`, { headers }).then(handle),
        getResponse: (id) => fetch(`${baseUrl}/v1/responses/${id}`, { headers }).then(handle),
        deleteResponse: (id) => fetch(`${baseUrl}/v1/responses/${id}`, { method: 'DELETE', headers }).then(handle),
        createResponse: (data) => {
          console.log('[API] createResponse called with:', data);
          console.log('[API] Sending POST to:', `${baseUrl}/v1/responses`);
          return fetch(`${baseUrl}/v1/responses`, { method: 'POST', headers, body: JSON.stringify(data) }).then(handle);
        },
        chatCompletion: (data) => {
          console.log('[API] chatCompletion called with:', data);
          return fetch(`${baseUrl}/v1/chat/completions`, { method: 'POST', headers, body: JSON.stringify(data) }).then(handle);
        },
        // Models API
        listModels: () => fetch(`${baseUrl}/v1/models`, { headers }).then(handle),
        // Tunnel API
        tunnelStatus: () => fetch(`${baseUrl}/admin/tunnel/status`, { headers }).then(handle),
        tunnelStart: () => fetch(`${baseUrl}/admin/tunnel/start`, { method: 'POST', headers }).then(handle),
        tunnelStop: () => fetch(`${baseUrl}/admin/tunnel/stop`, { method: 'POST', headers }).then(handle),
        // Config API
        getConfig: () => fetch(`${baseUrl}/admin/config`, { headers }).then(handle),
        updateConfig: (data) => fetch(`${baseUrl}/admin/config`, { method: 'PATCH', headers, body: JSON.stringify(data) }).then(handle),
        // Logs API
        getLogs: (limit = 100, since = 0) => {
          let url = `${baseUrl}/admin/logs?limit=${limit}`;
          if (since) url += `&since=${since}`;
          return fetch(url, { headers }).then(handle);
        },
        clearLogs: () => fetch(`${baseUrl}/admin/logs`, { method: 'DELETE', headers }).then(handle),
        // Generic request method for flexibility
        request: (path, options = {}) => {
          const url = path.startsWith('/') ? `${baseUrl}${path}` : `${baseUrl}/${path}`;
          return fetch(url, { headers, ...options }).then(handle);
        },
      };
    };

    // ============================================
    // Utils
    // ============================================
    const formatDate = (ts) => ts ? new Date(ts * 1000).toLocaleString('ja-JP') : '-';
    const formatDateShort = (ts) => ts ? new Date(ts * 1000).toLocaleDateString('ja-JP') : '-';
    const formatNum = (n) => n?.toLocaleString() || '0';
    const timeAgo = (ts) => {
      if (!ts) return '-';
      const s = Math.floor(Date.now() / 1000 - ts);
      if (s < 60) return `${s}秒前`;
      if (s < 3600) return `${Math.floor(s / 60)}分前`;
      if (s < 86400) return `${Math.floor(s / 3600)}時間前`;
      return `${Math.floor(s / 86400)}日前`;
    };
    const downloadFile = (content, filename, type = 'text/plain') => {
      const blob = new Blob([content], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    };

    // ============================================
    // Base Components
    // ============================================
    const Toast = ({ message, type, onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
      const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-blue-500' };
      return (
        <div className={`fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg animate-slide-up z-50 flex items-center gap-3`}>
          <span>{message}</span>
          <button onClick={onClose} className="hover:opacity-80"><Icons.X /></button>
        </div>
      );
    };

    const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
      if (!isOpen) return null;
      const sizes = { sm: 'max-w-md', md: 'max-w-lg', lg: 'max-w-2xl', xl: 'max-w-4xl', full: 'max-w-6xl' };
      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-40 p-4" onClick={onClose}>
          <div className={`card w-full ${sizes[size]} animate-slide-up max-h-[90vh] flex flex-col`} onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center px-6 py-4 border-b border-[var(--border)]">
              <h3 className="text-lg font-semibold">{title}</h3>
              <button onClick={onClose} className="p-1 rounded-lg hover:bg-[var(--bg-tertiary)] text-[var(--text-muted)]"><Icons.X /></button>
            </div>
            <div className="p-6 overflow-y-auto scrollbar-thin">{children}</div>
          </div>
        </div>
      );
    };

    const Spinner = ({ size = 'md' }) => {
      const s = { sm: 'w-4 h-4', md: 'w-8 h-8', lg: 'w-12 h-12' };
      return <div className={`${s[size]} border-2 border-[var(--border)] border-t-indigo-500 rounded-full animate-spin`} />;
    };

    const StatCard = ({ icon, label, value, sub, color = 'indigo', trend }) => {
      const colors = { indigo: 'from-indigo-500 to-purple-500', green: 'from-green-500 to-emerald-500', orange: 'from-orange-500 to-amber-500', blue: 'from-blue-500 to-cyan-500', pink: 'from-pink-500 to-rose-500' };
      return (
        <div className="card p-6">
          <div className="flex items-start justify-between">
            <div>
              <p className="text-[var(--text-muted)] text-sm font-medium">{label}</p>
              <p className="text-3xl font-bold mt-2">{value}</p>
              {sub && <p className="text-[var(--text-muted)] text-sm mt-1">{sub}</p>}
              {trend !== undefined && (
                <p className={`text-sm mt-2 ${trend >= 0 ? 'text-green-500' : 'text-red-500'}`}>
                  {trend >= 0 ? '↑' : '↓'} {Math.abs(trend)}% vs 昨日
                </p>
              )}
            </div>
            <div className={`w-14 h-14 bg-gradient-to-br ${colors[color]} rounded-2xl flex items-center justify-center text-white shadow-lg`}>{icon}</div>
          </div>
        </div>
      );
    };

    const ScopeBadge = ({ scope }) => {
      const s = { responses: 'badge-info', chat: 'badge-success', admin: 'badge-purple' };
      return <span className={`badge ${s[scope] || 'badge-info'}`}>{scope}</span>;
    };

    const StatusBadge = ({ isActive, expiresAt }) => {
      const now = Math.floor(Date.now() / 1000);
      if (!isActive) return <span className="badge badge-danger">無効</span>;
      if (expiresAt && expiresAt < now) return <span className="badge badge-warning">期限切れ</span>;
      return <span className="badge badge-success">有効</span>;
    };

    const Checkbox = ({ checked, onChange, label }) => (
      <label className="flex items-center gap-2 cursor-pointer">
        <div className={`w-5 h-5 rounded border-2 flex items-center justify-center transition ${checked ? 'bg-indigo-500 border-indigo-500' : 'border-[var(--border)]'}`}>
          {checked && <Icons.Check />}
        </div>
        {label && <span className="text-sm">{label}</span>}
      </label>
    );

    // ============================================
    // Chart Component
    // ============================================
    const UsageChart = ({ data, type = 'bar' }) => {
      const canvasRef = useRef(null);
      const chartRef = useRef(null);
      const { dark } = useTheme();

      useEffect(() => {
        if (!canvasRef.current || !data?.length) return;

        if (chartRef.current) chartRef.current.destroy();

        const ctx = canvasRef.current.getContext('2d');
        const textColor = dark ? '#94a3b8' : '#64748b';
        const gridColor = dark ? '#334155' : '#e2e8f0';

        chartRef.current = new Chart(ctx, {
          type,
          data: {
            labels: data.map(d => d.date?.slice(5) || d.label),
            datasets: [
              {
                label: 'リクエスト数',
                data: data.map(d => d.request_count || d.value),
                backgroundColor: 'rgba(99, 102, 241, 0.5)',
                borderColor: 'rgb(99, 102, 241)',
                borderWidth: 2,
                borderRadius: 4,
                tension: 0.3,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: { ticks: { color: textColor }, grid: { color: gridColor } },
              y: { ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true },
            },
          },
        });

        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [data, type, dark]);

      return <canvas ref={canvasRef} />;
    };

    // ============================================
    // Dashboard Page
    // ============================================
    const DashboardPage = ({ api, showToast }) => {
      const [health, setHealth] = useState(null);
      const [stats, setStats] = useState(null);
      const [processes, setProcesses] = useState(null);
      const [responses, setResponses] = useState([]);
      const [usageData, setUsageData] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      const load = useCallback(async () => {
        setError(null);
        try {
          // Force refresh to get latest provider status
          const h = await api.health(true);
          setHealth(h);

          // These require auth - handle failures gracefully
          const [s, p, r] = await Promise.all([
            api.getStats().catch(e => { console.log('Stats error:', e); return null; }),
            api.processStatus().catch(e => { console.log('Process error:', e); return null; }),
            api.listResponses(20).catch(e => { console.log('Responses error:', e); return { data: [] }; })
          ]);
          setStats(s);
          setProcesses(p);
          setResponses(r?.data || []);

          // Generate usage data from responses (real data, not mock)
          const usageByDate = {};
          (r?.data || []).forEach(resp => {
            if (resp.created_at) {
              const date = new Date(resp.created_at * 1000).toISOString().split('T')[0];
              usageByDate[date] = (usageByDate[date] || 0) + 1;
            }
          });

          // Fill in last 7 days
          const usage = [];
          for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split('T')[0];
            usage.push({
              date: dateStr,
              request_count: usageByDate[dateStr] || 0,
            });
          }
          setUsageData(usage);
        } catch (e) {
          console.error('Dashboard load error:', e);
          setError('データの読み込みに失敗しました');
        }
        finally { setLoading(false); }
      }, [api]);

      useEffect(() => { load(); const i = setInterval(load, 30000); return () => clearInterval(i); }, [load]);

      if (loading) return <div className="flex items-center justify-center h-64"><Spinner size="lg" /></div>;

      // Helper to render CLI status
      const renderCliStatus = (name, info) => {
        if (!info?.installed) return <span className="text-[var(--danger)]">✗ {name} 未インストール</span>;
        if (!info?.authenticated) return <span className="text-[var(--warning)]">△ {name} 未認証</span>;
        return <span className="text-[var(--success)]">✓ {name}</span>;
      };

      return (
        <div className="space-y-6 animate-fade-in">
          {error && (
            <div className="card p-4 border-[var(--danger)] bg-[#fef2f2]">
              <p className="text-sm text-[var(--danger)]">{error}</p>
            </div>
          )}

          {/* Server Status */}
          <div className="card p-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <div className="flex items-center gap-4">
                <span className={`status-dot ${health?.status === 'ok' ? 'status-online' : 'status-offline'}`} />
                <div>
                  <h3 className="font-semibold text-sm">サーバー状態</h3>
                  <p className="text-xs text-[var(--text-muted)] mt-1">
                    {renderCliStatus('Codex', health?.codex)} • {renderCliStatus('Claude', health?.claude)}
                  </p>
                </div>
              </div>
              <button onClick={load} className="btn btn-secondary flex items-center gap-2 text-xs"><Icons.Refresh />更新</button>
            </div>
          </div>

          {/* Stats Grid */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <StatCard icon={<Icons.Key />} label="APIキー数" value={formatNum(stats?.total_keys || 0)} sub={`${stats?.active_keys || 0} 有効`} color="gray" />
            <StatCard icon={<Icons.Activity />} label="本日のリクエスト" value={formatNum(stats?.total_requests_today || 0)} color="gray" />
            <StatCard icon={<Icons.Server />} label="アクティブプロセス" value={formatNum(processes?.active || 0)} sub={`${processes?.queued || 0} 待機中`} color="gray" />
            <StatCard icon={<Icons.History />} label="総レスポンス数" value={formatNum(health?.storage?.totalResponses || 0)} color="gray" />
          </div>

          {/* Charts - only show if there's data */}
          {usageData.some(d => d.request_count > 0) && (
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="card p-6">
                <h3 className="font-semibold text-sm mb-4">週間リクエスト数</h3>
                <div className="h-48">
                  <UsageChart data={usageData} type="bar" />
                </div>
              </div>
              <div className="card p-6">
                <h3 className="font-semibold text-sm mb-4">リクエスト推移</h3>
                <div className="h-48">
                  <UsageChart data={usageData} type="line" />
                </div>
              </div>
            </div>
          )}

          {/* Recent Activity */}
          <div className="card">
            <div className="px-6 py-4 border-b border-[var(--border)] flex justify-between items-center">
              <h3 className="font-semibold">最近のリクエスト</h3>
              <span className="text-sm text-[var(--text-muted)]">{responses.length}件</span>
            </div>
            <div className="divide-y divide-[var(--border)]">
              {responses.length === 0 ? (
                <div className="p-8 text-center text-[var(--text-muted)]">まだリクエストがありません</div>
              ) : responses.slice(0, 8).map(r => (
                <div key={r.id} className="px-6 py-3 flex items-center justify-between table-row">
                  <div className="flex items-center gap-4">
                    <div className={`w-2 h-2 rounded-full ${r.status === 'completed' ? 'bg-green-500' : r.status === 'failed' ? 'bg-red-500' : 'bg-yellow-500'}`} />
                    <div>
                      <p className="text-sm font-medium mono">{r.id.slice(0, 20)}...</p>
                      <p className="text-xs text-[var(--text-muted)]">{r.model}</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="text-sm text-[var(--text-secondary)]">{timeAgo(r.created_at)}</p>
                    <p className="text-xs text-[var(--text-muted)]">{r.usage?.total_tokens || 0} tokens</p>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // API Keys Page with Bulk Actions
    // ============================================
    const ApiKeysPage = ({ api, showToast }) => {
      const [keys, setKeys] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showInactive, setShowInactive] = useState(false);
      const [search, setSearch] = useState('');
      const [createModal, setCreateModal] = useState(false);
      const [createdKey, setCreatedKey] = useState(null);
      const [selectedKey, setSelectedKey] = useState(null);
      const [keyUsage, setKeyUsage] = useState(null);
      const [selectedIds, setSelectedIds] = useState(new Set());

      const load = useCallback(async () => {
        try { const r = await api.listKeys(showInactive); setKeys(r.data || []); setSelectedIds(new Set()); }
        catch (e) { showToast('読み込み失敗', 'error'); }
        finally { setLoading(false); }
      }, [api, showInactive]);

      useEffect(() => { load(); }, [load]);

      const handleCreate = async (data) => {
        try { const r = await api.createKey(data); setCreatedKey(r); setCreateModal(false); showToast('作成しました', 'success'); load(); }
        catch (e) { showToast('作成失敗', 'error'); }
      };

      const handleView = async (k) => {
        try {
          const [d, u] = await Promise.all([api.getKey(k.id), api.getUsage(k.id)]);
          setSelectedKey(d); setKeyUsage(u);
        } catch (e) { showToast('取得失敗', 'error'); }
      };

      const handleRevoke = async (id) => {
        if (!confirm('無効化しますか？')) return;
        try { await api.revokeKey(id); showToast('無効化しました', 'success'); setSelectedKey(null); load(); }
        catch (e) { showToast('失敗', 'error'); }
      };

      const handleDelete = async (id) => {
        if (!confirm('削除しますか？')) return;
        try { await api.deleteKey(id); showToast('削除しました', 'success'); setSelectedKey(null); load(); }
        catch (e) { showToast('失敗', 'error'); }
      };

      // Bulk actions
      const handleBulkRevoke = async () => {
        if (!confirm(`${selectedIds.size}件を無効化しますか？`)) return;
        try {
          await Promise.all([...selectedIds].map(id => api.revokeKey(id)));
          showToast(`${selectedIds.size}件を無効化しました`, 'success');
          load();
        } catch (e) { showToast('一部失敗しました', 'error'); load(); }
      };

      const handleBulkDelete = async () => {
        if (!confirm(`${selectedIds.size}件を削除しますか？この操作は取り消せません。`)) return;
        try {
          await Promise.all([...selectedIds].map(id => api.deleteKey(id)));
          showToast(`${selectedIds.size}件を削除しました`, 'success');
          load();
        } catch (e) { showToast('一部失敗しました', 'error'); load(); }
      };

      const handleExport = (format) => {
        const data = keys.filter(k => selectedIds.size === 0 || selectedIds.has(k.id));
        if (format === 'json') {
          downloadFile(JSON.stringify(data, null, 2), 'api-keys.json', 'application/json');
        } else {
          const csv = [
            ['ID', 'Name', 'Key', 'Scopes', 'Status', 'Created', 'Last Used', 'Rate Limit'].join(','),
            ...data.map(k => [k.id, k.name, k.key, k.scopes.join(';'), k.is_active ? 'Active' : 'Inactive', formatDate(k.created_at), formatDate(k.last_used_at), k.rate_limit || ''].join(','))
          ].join('\n');
          downloadFile(csv, 'api-keys.csv', 'text/csv');
        }
        showToast('エクスポートしました', 'success');
      };

      const toggleSelect = (id) => {
        const next = new Set(selectedIds);
        next.has(id) ? next.delete(id) : next.add(id);
        setSelectedIds(next);
      };

      const toggleSelectAll = () => {
        setSelectedIds(selectedIds.size === filtered.length ? new Set() : new Set(filtered.map(k => k.id)));
      };

      const filtered = useMemo(() => keys.filter(k => k.name.toLowerCase().includes(search.toLowerCase()) || k.id.includes(search)), [keys, search]);

      return (
        <div className="space-y-6 animate-fade-in">
          {/* Header */}
          <div className="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
            <div>
              <h2 className="text-2xl font-bold">APIキー管理</h2>
              <p className="text-[var(--text-muted)] mt-1">クライアント用APIキーの発行・管理</p>
            </div>
            <button onClick={() => setCreateModal(true)} className="btn-primary flex items-center gap-2"><Icons.Plus />新規作成</button>
          </div>

          {/* Filters & Bulk Actions */}
          <div className="card p-4">
            <div className="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
              <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center flex-1 w-full">
                <div className="relative flex-1 w-full sm:max-w-xs">
                  <input type="text" placeholder="検索..." value={search} onChange={e => setSearch(e.target.value)} className="input-field pl-10 w-full" />
                  <div className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-muted)]"><Icons.Search /></div>
                </div>
                <label className="flex items-center gap-2 cursor-pointer whitespace-nowrap">
                  <input type="checkbox" checked={showInactive} onChange={e => setShowInactive(e.target.checked)} className="w-4 h-4 text-indigo-600 rounded" />
                  <span className="text-sm">無効も表示</span>
                </label>
              </div>
              
              {/* Bulk Actions */}
              <div className="flex gap-2 flex-wrap">
                {selectedIds.size > 0 && (
                  <>
                    <span className="text-sm text-[var(--text-muted)] self-center mr-2">{selectedIds.size}件選択</span>
                    <button onClick={handleBulkRevoke} className="btn-secondary text-sm py-2 px-3 flex items-center gap-1">
                      <Icons.Ban />無効化
                    </button>
                    <button onClick={handleBulkDelete} className="btn-danger text-sm py-2 px-3 flex items-center gap-1">
                      <Icons.Trash />削除
                    </button>
                  </>
                )}
                <div className="relative group">
                  <button className="btn-secondary text-sm py-2 px-3 flex items-center gap-1">
                    <Icons.Download />エクスポート
                  </button>
                  <div className="absolute right-0 mt-1 w-32 card p-1 hidden group-hover:block z-10">
                    <button onClick={() => handleExport('csv')} className="w-full text-left px-3 py-2 text-sm rounded hover:bg-[var(--bg-tertiary)]">CSV</button>
                    <button onClick={() => handleExport('json')} className="w-full text-left px-3 py-2 text-sm rounded hover:bg-[var(--bg-tertiary)]">JSON</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Keys Table */}
          <div className="card overflow-hidden">
            {loading ? <div className="flex justify-center py-16"><Spinner /></div> : filtered.length === 0 ? (
              <div className="py-16 text-center text-[var(--text-muted)]">{search ? '検索結果なし' : 'APIキーがありません'}</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-[var(--bg-tertiary)]">
                    <tr>
                      <th className="px-4 py-3 text-left">
                        <Checkbox checked={selectedIds.size === filtered.length && filtered.length > 0} onChange={toggleSelectAll} />
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">キー名</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">キー</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">スコープ</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">状態</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">最終使用</th>
                      <th className="px-4 py-3 text-center text-xs font-semibold text-[var(--text-muted)] uppercase">操作</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-[var(--border)]">
                    {filtered.map(k => (
                      <tr key={k.id} className={`table-row ${selectedIds.has(k.id) ? 'bg-indigo-500/5' : ''}`}>
                        <td className="px-4 py-3">
                          <Checkbox checked={selectedIds.has(k.id)} onChange={() => toggleSelect(k.id)} />
                        </td>
                        <td className="px-4 py-3">
                          <p className="font-medium">{k.name}</p>
                          <p className="text-xs text-[var(--text-muted)] mono">{k.id}</p>
                        </td>
                        <td className="px-4 py-3"><code className="text-sm key-blur cursor-help">{k.key}</code></td>
                        <td className="px-4 py-3"><div className="flex gap-1 flex-wrap">{k.scopes.map(s => <ScopeBadge key={s} scope={s} />)}</div></td>
                        <td className="px-4 py-3"><StatusBadge isActive={k.is_active} expiresAt={k.expires_at} /></td>
                        <td className="px-4 py-3 text-sm text-[var(--text-secondary)]">{timeAgo(k.last_used_at)}</td>
                        <td className="px-4 py-3">
                          <div className="flex justify-center gap-1">
                            <button onClick={() => handleView(k)} className="p-2 text-[var(--text-muted)] hover:text-indigo-500 hover:bg-indigo-500/10 rounded-lg" title="詳細"><Icons.Eye /></button>
                            {k.is_active && <button onClick={() => handleRevoke(k.id)} className="p-2 text-[var(--text-muted)] hover:text-orange-500 hover:bg-orange-500/10 rounded-lg" title="無効化"><Icons.Ban /></button>}
                            <button onClick={() => handleDelete(k.id)} className="p-2 text-[var(--text-muted)] hover:text-red-500 hover:bg-red-500/10 rounded-lg" title="削除"><Icons.Trash /></button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* Modals */}
          <Modal isOpen={createModal} onClose={() => setCreateModal(false)} title="新規APIキー作成">
            <CreateKeyForm onSubmit={handleCreate} onCancel={() => setCreateModal(false)} />
          </Modal>
          <Modal isOpen={!!createdKey} onClose={() => setCreatedKey(null)} title="APIキー作成完了">
            {createdKey && <CreatedKeyDisplay data={createdKey} onClose={() => setCreatedKey(null)} />}
          </Modal>
          <Modal isOpen={!!selectedKey} onClose={() => setSelectedKey(null)} title={selectedKey?.name} size="lg">
            {selectedKey && <KeyDetail apiKey={selectedKey} usage={keyUsage} onRevoke={handleRevoke} onDelete={handleDelete} onClose={() => setSelectedKey(null)} />}
          </Modal>
        </div>
      );
    };

    // Create Key Form
    const CreateKeyForm = ({ onSubmit, onCancel }) => {
      const [form, setForm] = useState({ name: '', scopes: ['responses', 'chat'], rate_limit: '', expires_in_days: '' });
      const toggle = (s) => setForm(p => ({ ...p, scopes: p.scopes.includes(s) ? p.scopes.filter(x => x !== s) : [...p.scopes, s] }));
      const submit = (e) => { e.preventDefault(); const d = { name: form.name, scopes: form.scopes }; if (form.rate_limit) d.rate_limit = parseInt(form.rate_limit); if (form.expires_in_days) d.expires_in_days = parseInt(form.expires_in_days); onSubmit(d); };
      return (
        <form onSubmit={submit} className="space-y-6">
          <div>
            <label className="block text-sm font-medium mb-2">キー名 *</label>
            <input type="text" value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} placeholder="例: Production App" className="input-field" required />
          </div>
          <div>
            <label className="block text-sm font-medium mb-3">スコープ</label>
            <div className="flex flex-wrap gap-3">
              {[{ id: 'responses', label: 'Responses API' }, { id: 'chat', label: 'Chat API' }, { id: 'admin', label: '管理者' }].map(s => (
                <label key={s.id} className={`flex items-center gap-3 p-4 rounded-xl border-2 cursor-pointer transition ${form.scopes.includes(s.id) ? 'border-indigo-500 bg-indigo-500/10' : 'border-[var(--border)] hover:border-indigo-300'}`}>
                  <input type="checkbox" checked={form.scopes.includes(s.id)} onChange={() => toggle(s.id)} className="sr-only" />
                  <span className="font-medium">{s.label}</span>
                </label>
              ))}
            </div>
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-2">レート制限</label>
              <div className="relative"><input type="number" value={form.rate_limit} onChange={e => setForm({ ...form, rate_limit: e.target.value })} placeholder="無制限" className="input-field pr-16" /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)] text-sm">回/分</span></div>
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">有効期限</label>
              <div className="relative"><input type="number" value={form.expires_in_days} onChange={e => setForm({ ...form, expires_in_days: e.target.value })} placeholder="無期限" className="input-field pr-12" /><span className="absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)] text-sm">日後</span></div>
            </div>
          </div>
          <div className="flex gap-3 pt-4"><button type="submit" className="btn-primary flex-1">作成</button><button type="button" onClick={onCancel} className="btn-secondary flex-1">キャンセル</button></div>
        </form>
      );
    };

    // Created Key Display
    const CreatedKeyDisplay = ({ data, onClose }) => {
      const [copied, setCopied] = useState(false);
      const copy = async () => { await navigator.clipboard.writeText(data.key); setCopied(true); setTimeout(() => setCopied(false), 2000); };
      return (
        <div className="space-y-6">
          <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4 flex items-start gap-3">
            <span className="text-2xl">⚠️</span>
            <div><p className="font-semibold text-amber-600">このキーは一度しか表示されません</p><p className="text-sm text-amber-600/80 mt-1">必ず安全な場所に保存してください。</p></div>
          </div>
          <div className="bg-[var(--bg-tertiary)] rounded-xl p-4">
            <label className="block text-sm font-medium text-[var(--text-muted)] mb-2">APIキー</label>
            <div className="flex items-center gap-2">
              <code className="flex-1 bg-[var(--bg-secondary)] px-4 py-3 rounded-lg border border-[var(--border)] mono text-sm break-all select-all">{data.key}</code>
              <button onClick={copy} className={`px-4 py-3 rounded-lg font-medium flex items-center gap-2 transition ${copied ? 'bg-green-500 text-white' : 'btn-primary'}`}>{copied ? <><Icons.Check /> コピー済み</> : <><Icons.Copy /> コピー</>}</button>
            </div>
          </div>
          <button onClick={onClose} className="w-full bg-[var(--text-primary)] text-[var(--bg-primary)] py-3 rounded-xl font-medium hover:opacity-90">閉じる</button>
        </div>
      );
    };

    // Key Detail with Usage Chart
    const KeyDetail = ({ apiKey, usage, onRevoke, onDelete, onClose }) => (
      <div className="space-y-6">
        <div className="grid grid-cols-2 gap-4">
          {[{ l: 'キーID', v: <span className="mono text-xs">{apiKey.id}</span> }, { l: 'ステータス', v: <StatusBadge isActive={apiKey.is_active} expiresAt={apiKey.expires_at} /> }, { l: '作成日時', v: formatDate(apiKey.created_at) }, { l: '最終使用', v: apiKey.last_used_at ? formatDate(apiKey.last_used_at) : '未使用' }, { l: '有効期限', v: apiKey.expires_at ? formatDate(apiKey.expires_at) : '無期限' }, { l: 'レート制限', v: apiKey.rate_limit ? `${apiKey.rate_limit}回/分` : '無制限' }].map((i, idx) => (
            <div key={idx} className="bg-[var(--bg-tertiary)] rounded-xl p-4"><p className="text-xs text-[var(--text-muted)] mb-1">{i.l}</p><p>{i.v}</p></div>
          ))}
        </div>
        <div><label className="block text-sm font-medium mb-2">スコープ</label><div className="flex gap-2 flex-wrap">{apiKey.scopes.map(s => <ScopeBadge key={s} scope={s} />)}</div></div>
        {usage && (
          <div className="bg-gradient-to-r from-indigo-500/10 to-purple-500/10 rounded-xl p-6">
            <h4 className="font-semibold mb-4">使用量サマリー</h4>
            <div className="grid grid-cols-3 gap-4 text-center">
              <div><p className="text-3xl font-bold text-indigo-500">{formatNum(usage.summary?.total_requests)}</p><p className="text-sm text-[var(--text-muted)] mt-1">リクエスト</p></div>
              <div><p className="text-3xl font-bold text-purple-500">{formatNum(usage.summary?.total_input_tokens)}</p><p className="text-sm text-[var(--text-muted)] mt-1">入力トークン</p></div>
              <div><p className="text-3xl font-bold text-pink-500">{formatNum(usage.summary?.total_output_tokens)}</p><p className="text-sm text-[var(--text-muted)] mt-1">出力トークン</p></div>
            </div>
            {usage.daily?.length > 0 && (
              <div className="mt-4 h-40">
                <UsageChart data={usage.daily} type="bar" />
              </div>
            )}
          </div>
        )}
        <div className="flex gap-3 pt-4 border-t border-[var(--border)]">
          {apiKey.is_active && <button onClick={() => onRevoke(apiKey.id)} className="flex-1 bg-orange-500 text-white py-3 rounded-xl font-medium hover:bg-orange-600">無効化</button>}
          <button onClick={() => onDelete(apiKey.id)} className="flex-1 bg-red-500 text-white py-3 rounded-xl font-medium hover:bg-red-600">削除</button>
          <button onClick={onClose} className="flex-1 btn-secondary py-3">閉じる</button>
        </div>
      </div>
    );

    // ============================================
    // Responses Page
    // ============================================
    const ResponsesPage = ({ api, showToast }) => {
      const [responses, setResponses] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selected, setSelected] = useState(null);
      const [search, setSearch] = useState('');
      const [selectedIds, setSelectedIds] = useState(new Set());

      const load = useCallback(async () => {
        try { const r = await api.listResponses(100); setResponses(r.data || []); setSelectedIds(new Set()); }
        catch (e) { showToast('読み込み失敗', 'error'); }
        finally { setLoading(false); }
      }, [api]);

      useEffect(() => { load(); }, [load]);

      const handleDelete = async (id) => {
        if (!confirm('削除しますか？')) return;
        try { await api.deleteResponse(id); showToast('削除しました', 'success'); setSelected(null); load(); }
        catch (e) { showToast('失敗', 'error'); }
      };

      const handleBulkDelete = async () => {
        if (!confirm(`${selectedIds.size}件を削除しますか？`)) return;
        try {
          await Promise.all([...selectedIds].map(id => api.deleteResponse(id)));
          showToast(`${selectedIds.size}件を削除しました`, 'success');
          load();
        } catch (e) { showToast('一部失敗しました', 'error'); load(); }
      };

      const handleExport = () => {
        const data = responses.filter(r => selectedIds.size === 0 || selectedIds.has(r.id));
        downloadFile(JSON.stringify(data, null, 2), 'responses.json', 'application/json');
        showToast('エクスポートしました', 'success');
      };

      const toggleSelect = (id) => {
        const next = new Set(selectedIds);
        next.has(id) ? next.delete(id) : next.add(id);
        setSelectedIds(next);
      };

      const filtered = useMemo(() => responses.filter(r => r.id.includes(search) || r.model?.includes(search)), [responses, search]);
      const statusColors = { completed: 'badge-success', failed: 'badge-danger', cancelled: 'badge-warning', in_progress: 'badge-info', queued: 'badge-info' };

      return (
        <div className="space-y-6 animate-fade-in">
          <div className="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
            <div><h2 className="text-2xl font-bold">レスポンス履歴</h2><p className="text-[var(--text-muted)] mt-1">過去のAPIリクエスト</p></div>
            <button onClick={load} className="btn-secondary flex items-center gap-2"><Icons.Refresh />更新</button>
          </div>

          <div className="card p-4">
            <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
              <div className="relative flex-1 w-full sm:max-w-xs">
                <input type="text" placeholder="ID/モデルで検索..." value={search} onChange={e => setSearch(e.target.value)} className="input-field pl-10 w-full" />
                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--text-muted)]"><Icons.Search /></div>
              </div>
              <div className="flex gap-2">
                {selectedIds.size > 0 && (
                  <>
                    <span className="text-sm text-[var(--text-muted)] self-center mr-2">{selectedIds.size}件選択</span>
                    <button onClick={handleBulkDelete} className="btn-danger text-sm py-2 px-3 flex items-center gap-1"><Icons.Trash />削除</button>
                  </>
                )}
                <button onClick={handleExport} className="btn-secondary text-sm py-2 px-3 flex items-center gap-1"><Icons.Download />JSON</button>
              </div>
            </div>
          </div>

          <div className="card overflow-hidden">
            {loading ? <div className="flex justify-center py-16"><Spinner /></div> : filtered.length === 0 ? (
              <div className="py-16 text-center text-[var(--text-muted)]">履歴がありません</div>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-[var(--bg-tertiary)]">
                    <tr>
                      <th className="px-4 py-3 text-left"><Checkbox checked={selectedIds.size === filtered.length && filtered.length > 0} onChange={() => setSelectedIds(selectedIds.size === filtered.length ? new Set() : new Set(filtered.map(r => r.id)))} /></th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">ID</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">モデル</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">状態</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">トークン</th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-[var(--text-muted)] uppercase">作成日時</th>
                      <th className="px-4 py-3 text-center text-xs font-semibold text-[var(--text-muted)] uppercase">操作</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-[var(--border)]">
                    {filtered.map(r => (
                      <tr key={r.id} className={`table-row ${selectedIds.has(r.id) ? 'bg-indigo-500/5' : ''}`}>
                        <td className="px-4 py-3"><Checkbox checked={selectedIds.has(r.id)} onChange={() => toggleSelect(r.id)} /></td>
                        <td className="px-4 py-3"><code className="text-sm">{r.id.slice(0, 24)}...</code></td>
                        <td className="px-4 py-3 text-sm">{r.model}</td>
                        <td className="px-4 py-3"><span className={`badge ${statusColors[r.status] || 'badge-info'}`}>{r.status}</span></td>
                        <td className="px-4 py-3 text-sm">{formatNum(r.usage?.total_tokens)}</td>
                        <td className="px-4 py-3 text-sm text-[var(--text-secondary)]">{formatDate(r.created_at)}</td>
                        <td className="px-4 py-3">
                          <div className="flex justify-center gap-1">
                            <button onClick={() => setSelected(r)} className="p-2 text-[var(--text-muted)] hover:text-indigo-500 hover:bg-indigo-500/10 rounded-lg"><Icons.Eye /></button>
                            <button onClick={() => handleDelete(r.id)} className="p-2 text-[var(--text-muted)] hover:text-red-500 hover:bg-red-500/10 rounded-lg"><Icons.Trash /></button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          <Modal isOpen={!!selected} onClose={() => setSelected(null)} title="レスポンス詳細" size="lg">
            {selected && (
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div className="bg-[var(--bg-tertiary)] rounded-xl p-4"><p className="text-[var(--text-muted)] mb-1">ID</p><code>{selected.id}</code></div>
                  <div className="bg-[var(--bg-tertiary)] rounded-xl p-4"><p className="text-[var(--text-muted)] mb-1">モデル</p><p>{selected.model}</p></div>
                  <div className="bg-[var(--bg-tertiary)] rounded-xl p-4"><p className="text-[var(--text-muted)] mb-1">状態</p><span className={`badge ${statusColors[selected.status]}`}>{selected.status}</span></div>
                  <div className="bg-[var(--bg-tertiary)] rounded-xl p-4"><p className="text-[var(--text-muted)] mb-1">作成日時</p><p>{formatDate(selected.created_at)}</p></div>
                </div>
                {selected.output_text && <div><label className="block text-sm font-medium mb-2">出力</label><div className="bg-gray-900 text-gray-100 rounded-xl p-4 mono text-sm max-h-64 overflow-y-auto whitespace-pre-wrap">{selected.output_text}</div></div>}
                {selected.usage && (
                  <div className="bg-indigo-500/10 rounded-xl p-4">
                    <p className="font-medium mb-2">使用量</p>
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div><p className="text-xl font-bold text-indigo-500">{formatNum(selected.usage.input_tokens)}</p><p className="text-xs text-[var(--text-muted)]">入力</p></div>
                      <div><p className="text-xl font-bold text-purple-500">{formatNum(selected.usage.output_tokens)}</p><p className="text-xs text-[var(--text-muted)]">出力</p></div>
                      <div><p className="text-xl font-bold text-pink-500">{formatNum(selected.usage.total_tokens)}</p><p className="text-xs text-[var(--text-muted)]">合計</p></div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </Modal>
        </div>
      );
    };

    // ============================================
    // Playground Page
    // ============================================
    const PlaygroundPage = ({ api, showToast }) => {
      const [mode, setMode] = useState('responses'); // 'responses' or 'chat'
      const [input, setInput] = useState('');
      const [model, setModel] = useState('');
      const [result, setResult] = useState(null);
      const [loading, setLoading] = useState(false);
      const [history, setHistory] = useState([]);
      const [availableModels, setAvailableModels] = useState([]);
      const [modelsLoading, setModelsLoading] = useState(true);

      // Load available models from API based on authenticated providers
      useEffect(() => {
        const loadModels = async () => {
          try {
            // Get health status and models list in parallel
            const [health, modelsResponse] = await Promise.all([
              api.health(true),
              api.listModels()
            ]);

            const allModels = modelsResponse.data || [];

            // Filter models based on authenticated providers
            const models = allModels.filter(m => {
              if (m.provider === 'codex' && health.codex?.authenticated) return true;
              if (m.provider === 'claude' && health.claude?.authenticated) return true;
              return false;
            }).map(m => ({
              id: m.id,
              name: m.id,
              provider: m.provider
            }));

            setAvailableModels(models);
            // Set default model to first available
            if (models.length > 0 && !model) {
              setModel(models[0].id);
            }
          } catch (e) {
            console.error('Failed to load models:', e);
            // Fallback: show basic models if API fails
            setAvailableModels([
              { id: 'claude-sonnet-4', name: 'claude-sonnet-4', provider: 'claude' },
            ]);
          } finally {
            setModelsLoading(false);
          }
        };
        loadModels();
      }, []);

      const run = async () => {
        if (!input.trim()) return;
        setLoading(true);
        setResult(null);
        console.log('[Playground] Starting request - mode:', mode, 'model:', model, 'input:', input.substring(0, 50));
        try {
          let res;
          if (mode === 'responses') {
            console.log('[Playground] Calling createResponse...');
            res = await api.createResponse({ model, input });
            console.log('[Playground] createResponse returned:', res);
          } else {
            console.log('[Playground] Calling chatCompletion...');
            res = await api.chatCompletion({
              model,
              messages: [{ role: 'user', content: input }],
            });
            console.log('[Playground] chatCompletion returned:', res);
          }
          setResult(res);
          setHistory(h => [{ time: new Date(), mode, input, result: res }, ...h].slice(0, 20));
          showToast('実行完了', 'success');
        } catch (e) {
          console.error('[Playground] Error:', e);
          setResult({ error: e.message });
          showToast('実行失敗', 'error');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="space-y-6 animate-fade-in">
          <div><h2 className="text-2xl font-bold">API Playground</h2><p className="text-[var(--text-muted)] mt-1">APIをブラウザから直接テスト</p></div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Input Panel */}
            <div className="card p-6 space-y-4">
              <div className="flex gap-2">
                <button onClick={() => setMode('responses')} className={`flex-1 py-2 px-4 rounded-lg font-medium transition ${mode === 'responses' ? 'bg-indigo-500 text-white' : 'bg-[var(--bg-tertiary)]'}`}>Responses API</button>
                <button onClick={() => setMode('chat')} className={`flex-1 py-2 px-4 rounded-lg font-medium transition ${mode === 'chat' ? 'bg-indigo-500 text-white' : 'bg-[var(--bg-tertiary)]'}`}>Chat API</button>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">モデル</label>
                {modelsLoading ? (
                  <div className="input-field flex items-center gap-2 text-[var(--text-muted)]">
                    <Spinner size="sm" />読み込み中...
                  </div>
                ) : availableModels.length === 0 ? (
                  <div className="input-field text-[var(--text-muted)]">
                    利用可能なモデルがありません（CLI認証が必要です）
                  </div>
                ) : (
                  <select value={model} onChange={e => setModel(e.target.value)} className="input-field">
                    {availableModels.map(m => (
                      <option key={m.id} value={m.id}>{m.name} ({m.provider})</option>
                    ))}
                  </select>
                )}
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">入力</label>
                <textarea
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  placeholder={mode === 'responses' ? 'プロンプトを入力...' : 'メッセージを入力...'}
                  className="input-field h-40 resize-none"
                />
              </div>

              <button onClick={run} disabled={loading || !input.trim()} className="w-full btn-primary flex items-center justify-center gap-2 disabled:opacity-50">
                {loading ? <Spinner size="sm" /> : <Icons.Play />}
                {loading ? '実行中...' : '実行'}
              </button>
            </div>

            {/* Output Panel */}
            <div className="card p-6">
              <h3 className="font-semibold mb-4">結果</h3>
              {result ? (
                <div className="space-y-4">
                  {result.error ? (
                    <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-red-500">{result.error}</div>
                  ) : (
                    <>
                      <div className="bg-gray-900 text-gray-100 rounded-xl p-4 mono text-sm max-h-80 overflow-y-auto whitespace-pre-wrap scrollbar-thin">
                        {result.output_text || result.choices?.[0]?.message?.content || JSON.stringify(result, null, 2)}
                      </div>
                      {result.usage && (
                        <div className="flex gap-4 text-sm text-[var(--text-muted)]">
                          <span>入力: {result.usage.input_tokens}</span>
                          <span>出力: {result.usage.output_tokens}</span>
                          <span>合計: {result.usage.total_tokens}</span>
                        </div>
                      )}
                    </>
                  )}
                </div>
              ) : (
                <div className="h-64 flex items-center justify-center text-[var(--text-muted)]">結果がここに表示されます</div>
              )}
            </div>
          </div>

          {/* History */}
          {history.length > 0 && (
            <div className="card">
              <div className="px-6 py-4 border-b border-[var(--border)]"><h3 className="font-semibold">実行履歴</h3></div>
              <div className="divide-y divide-[var(--border)] max-h-64 overflow-y-auto scrollbar-thin">
                {history.map((h, i) => (
                  <div key={i} className="px-6 py-3 flex items-center justify-between table-row cursor-pointer" onClick={() => { setMode(h.mode); setInput(h.input); setResult(h.result); }}>
                    <div>
                      <p className="text-sm font-medium">{h.input.slice(0, 50)}...</p>
                      <p className="text-xs text-[var(--text-muted)]">{h.mode} • {h.time.toLocaleTimeString()}</p>
                    </div>
                    <span className={`badge ${h.result.error ? 'badge-danger' : 'badge-success'}`}>{h.result.error ? 'Error' : 'OK'}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // Logs Page
    // ============================================
    const LogsPage = ({ api, showToast }) => {
      const [logs, setLogs] = useState([]);
      const [filter, setFilter] = useState('all');
      const [autoScroll, setAutoScroll] = useState(true);
      const [latestId, setLatestId] = useState(0);
      const [loading, setLoading] = useState(true);
      const logsEndRef = useRef(null);

      // Fetch logs with polling
      const fetchLogs = useCallback(async (since = 0) => {
        try {
          const res = await api.request('/admin/logs?limit=100' + (since ? `&since=${since}` : ''));
          if (res.data && res.data.length > 0) {
            setLogs(prev => {
              const newLogs = res.data.map(l => ({
                id: l.id,
                time: new Date(l.timestamp),
                type: l.type,
                category: l.category,
                message: l.message,
                details: l.details,
              }));
              if (since === 0) {
                return newLogs;
              }
              // Merge new logs, avoiding duplicates
              const existingIds = new Set(prev.map(l => l.id));
              const toAdd = newLogs.filter(l => !existingIds.has(l.id));
              return [...prev, ...toAdd].slice(-100);
            });
          }
          if (res.latest_id) {
            setLatestId(res.latest_id);
          }
        } catch (e) {
          console.error('Failed to fetch logs:', e);
        } finally {
          setLoading(false);
        }
      }, [api]);

      // Initial load
      useEffect(() => {
        fetchLogs(0);
      }, [fetchLogs]);

      // Poll for new logs every 2 seconds
      useEffect(() => {
        const interval = setInterval(() => {
          fetchLogs(latestId);
        }, 2000);
        return () => clearInterval(interval);
      }, [fetchLogs, latestId]);

      useEffect(() => {
        if (autoScroll && logs.length > 0) logsEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [logs, autoScroll]);

      const filtered = filter === 'all' ? logs : logs.filter(l => l.type === filter);

      const handleExport = () => {
        const content = logs.map(l => `[${l.time.toISOString()}] [${l.type.toUpperCase()}] [${l.category}] ${l.message}`).join('\n');
        downloadFile(content, 'logs.txt');
        showToast('エクスポートしました', 'success');
      };

      const handleClear = async () => {
        try {
          await api.request('/admin/logs', { method: 'DELETE' });
          setLogs([]);
          setLatestId(0);
          showToast('ログをクリアしました', 'success');
        } catch (e) {
          showToast('クリアに失敗しました', 'error');
        }
      };

      return (
        <div className="space-y-6 animate-fade-in">
          <div className="flex flex-col sm:flex-row gap-4 justify-between items-start sm:items-center">
            <div><h2 className="text-2xl font-bold">リアルタイムログ</h2><p className="text-[var(--text-muted)] mt-1">サーバーログのライブ表示</p></div>
            <div className="flex gap-2">
              <label className="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" checked={autoScroll} onChange={e => setAutoScroll(e.target.checked)} className="w-4 h-4 text-indigo-600 rounded" />
                <span className="text-sm">自動スクロール</span>
              </label>
              <button onClick={handleClear} className="btn-secondary text-sm py-2 px-3 flex items-center gap-1"><Icons.Trash />クリア</button>
              <button onClick={handleExport} className="btn-secondary text-sm py-2 px-3 flex items-center gap-1"><Icons.Download />エクスポート</button>
            </div>
          </div>

          <div className="card p-4">
            <div className="flex gap-2">
              {['all', 'info', 'success', 'warning', 'error'].map(f => (
                <button key={f} onClick={() => setFilter(f)} className={`px-4 py-2 rounded-lg text-sm font-medium transition ${filter === f ? 'bg-indigo-500 text-white' : 'bg-[var(--bg-tertiary)]'}`}>
                  {f === 'all' ? 'すべて' : f.charAt(0).toUpperCase() + f.slice(1)}
                </button>
              ))}
            </div>
          </div>

          <div className="card">
            <div className="h-96 overflow-y-auto scrollbar-thin p-4 bg-gray-900 rounded-xl mono text-sm">
              {loading ? (
                <div className="h-full flex items-center justify-center text-gray-500">
                  <Spinner size="md" />
                </div>
              ) : filtered.length === 0 ? (
                <div className="h-full flex items-center justify-center text-gray-500">
                  <div className="text-center">
                    <p>ログはありません</p>
                    <p className="text-xs mt-2">APIリクエストがあるとここにログが表示されます</p>
                  </div>
                </div>
              ) : (
                filtered.map(log => (
                  <div key={log.id} className={`log-line log-${log.type} py-1`}>
                    <span className="text-gray-500">[{log.time.toLocaleTimeString()}]</span>
                    <span className={`ml-2 ${log.type === 'error' ? 'text-red-400' : log.type === 'warning' ? 'text-yellow-400' : log.type === 'success' ? 'text-green-400' : 'text-blue-400'}`}>[{log.type.toUpperCase()}]</span>
                    <span className="ml-2 text-purple-400">[{log.category}]</span>
                    <span className="ml-2 text-gray-300">{log.message}</span>
                  </div>
                ))
              )}
              <div ref={logsEndRef} />
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Settings Page
    // ============================================
    const SettingsPage = ({ api, serverUrl, showToast }) => {
      const [health, setHealth] = useState(null);
      const [config, setConfig] = useState(null);
      const [models, setModels] = useState([]);
      const [tunnel, setTunnel] = useState({ active: false, url: null });
      const [tunnelInstalled, setTunnelInstalled] = useState(null); // null = checking, true/false = result
      const [tunnelInstalling, setTunnelInstalling] = useState(false);
      const [loading, setLoading] = useState(true);
      const [tunnelLoading, setTunnelLoading] = useState(false);
      const [serverLoading, setServerLoading] = useState(false);
      const [serverStatus, setServerStatus] = useState({ running: true });
      const [portConflict, setPortConflict] = useState(null);
      const [killOnClose, setKillOnClose] = useState(() => {
        const saved = localStorage.getItem('killOnClose');
        return saved !== null ? JSON.parse(saved) : true;
      });
      const [portInput, setPortInput] = useState('');
      const [advancedOpen, setAdvancedOpen] = useState(false);
      const [customPaths, setCustomPaths] = useState({
        npm: '',
        claude: '',
        codex: '',
        cloudflared: '',
      });
      const { dark, toggle } = useTheme();
      const [notifications, setNotifications] = useState({
        rateLimit: true,
        expiration: true,
        errors: false,
      });
      const [copied, setCopied] = useState(false);

      const loadData = useCallback(async () => {
        try {
          const [h, c, t, m] = await Promise.all([
            // Force refresh to get latest provider status
            api.health(true),
            api.getConfig().catch(() => null),
            api.tunnelStatus().catch(() => ({ active: false })),
            api.listModels().catch(() => ({ data: [] })),
          ]);
          setHealth(h);
          setConfig(c);
          setTunnel(t);
          setModels(m.data || []);
          if (c?.port) setPortInput(String(c.port));
        } catch (e) {
          showToast('読み込み失敗', 'error');
        } finally {
          setLoading(false);
        }
      }, [api]);

      useEffect(() => { loadData(); }, [loadData]);

      // Check if cloudflared is installed
      useEffect(() => {
        if (window.electronAPI) {
          window.electronAPI.isTunnelInstalled().then(setTunnelInstalled);
        }
      }, []);

      // Load killOnClose setting from Electron config
      useEffect(() => {
        if (window.electronAPI) {
          window.electronAPI.getConfig().then(cfg => {
            if (cfg && cfg.killOnClose !== undefined) {
              setKillOnClose(cfg.killOnClose);
              localStorage.setItem('killOnClose', JSON.stringify(cfg.killOnClose));
            }
            // Load custom paths
            setCustomPaths({
              npm: cfg?.customNpmPath || '',
              claude: cfg?.customClaudePath || '',
              codex: cfg?.customCodexPath || '',
              cloudflared: cfg?.customCloudflaredPath || '',
            });
          });
        }
      }, []);

      const handleCustomPathSave = async (key, configKey, value) => {
        if (window.electronAPI) {
          await window.electronAPI.setConfig(configKey, value);
          setCustomPaths(prev => ({ ...prev, [key]: value }));
          showToast('パスを保存しました。次のリクエストから適用されます。', 'success');
        }
      };

      const handleTunnelStart = async () => {
        setTunnelLoading(true);
        try {
          const result = await api.tunnelStart();
          setTunnel(result);
          if (result.url) showToast('トンネルを開始しました', 'success');
        } catch (e) {
          showToast(e.message || 'トンネル開始失敗', 'error');
        } finally {
          setTunnelLoading(false);
        }
      };

      const handleTunnelStop = async () => {
        try {
          await api.tunnelStop();
          setTunnel({ active: false, url: null });
          showToast('トンネルを停止しました', 'success');
        } catch (e) {
          showToast('トンネル停止失敗', 'error');
        }
      };

      const handleTunnelInstall = async () => {
        if (!window.electronAPI) return;
        setTunnelInstalling(true);
        try {
          const result = await window.electronAPI.installTunnel();
          if (result.success) {
            setTunnelInstalled(true);
            showToast('cloudflaredをインストールしました', 'success');
          } else {
            showToast(result.message || 'インストール失敗', 'error');
          }
        } catch (e) {
          showToast('インストール失敗', 'error');
        } finally {
          setTunnelInstalling(false);
        }
      };

      // Server control handlers
      const handleServerStart = async () => {
        setServerLoading(true);
        setPortConflict(null);
        try {
          if (window.electronAPI) {
            const result = await window.electronAPI.startServer();
            if (result.portConflict) {
              setPortConflict(result.portConflict);
              showToast(`ポート ${result.portConflict.port} は既に使用されています`, 'error');
            } else if (result.running) {
              setServerStatus({ running: true });
              showToast('サーバーを起動しました', 'success');
              loadData();
            } else {
              showToast(result.error || 'サーバー起動失敗', 'error');
            }
          }
        } catch (e) {
          showToast('サーバー起動失敗', 'error');
        } finally {
          setServerLoading(false);
        }
      };

      const handleServerStop = async () => {
        setServerLoading(true);
        try {
          if (window.electronAPI) {
            await window.electronAPI.stopServer();
            setServerStatus({ running: false });
            showToast('サーバーを停止しました', 'success');
          }
        } catch (e) {
          showToast('サーバー停止失敗', 'error');
        } finally {
          setServerLoading(false);
        }
      };

      const handleServerRestart = async () => {
        setServerLoading(true);
        setPortConflict(null);
        try {
          if (window.electronAPI) {
            const result = await window.electronAPI.restartServer();
            if (result.running) {
              setServerStatus({ running: true });
              showToast('サーバーを再起動しました', 'success');
              loadData();
            } else {
              showToast(result.error || 'サーバー再起動失敗', 'error');
            }
          }
        } catch (e) {
          showToast('サーバー再起動失敗', 'error');
        } finally {
          setServerLoading(false);
        }
      };

      const handleKillConflictProcess = async () => {
        if (!portConflict) return;
        try {
          if (window.electronAPI) {
            const killed = await window.electronAPI.killPortProcess(portConflict.pid);
            if (killed) {
              setPortConflict(null);
              showToast('プロセスを終了しました', 'success');
              // Try to start server again after a short delay
              setTimeout(handleServerStart, 500);
            } else {
              showToast('プロセス終了失敗', 'error');
            }
          }
        } catch (e) {
          showToast('プロセス終了失敗', 'error');
        }
      };

      const handleKillOnCloseToggle = (value) => {
        setKillOnClose(value);
        localStorage.setItem('killOnClose', JSON.stringify(value));
        if (window.electronAPI) {
          window.electronAPI.setConfig('killOnClose', value);
        }
      };

      const handlePortSave = async () => {
        const port = parseInt(portInput);
        if (isNaN(port) || port < 1 || port > 65535) {
          showToast('有効なポート番号を入力してください', 'error');
          return;
        }
        try {
          const result = await api.updateConfig({ port });
          showToast(result.requiresRestart ? 'ポート設定を保存しました（再起動後に適用）' : '設定を更新しました', 'success');
        } catch (e) {
          showToast('設定更新失敗', 'error');
        }
      };

      const handleModelChange = async (newModel) => {
        try {
          await api.updateConfig({ defaultModel: newModel });
          setHealth(prev => ({ ...prev, config: { ...prev?.config, defaultModel: newModel } }));
          showToast('デフォルトモデルを変更しました', 'success');
        } catch (e) {
          showToast('モデル変更失敗', 'error');
        }
      };

      const copyUrl = async (url) => {
        await navigator.clipboard.writeText(url);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      const handleConfigChange = async (key, value) => {
        try {
          await api.updateConfig({ [key]: value });
          setConfig(prev => ({ ...prev, [key]: value }));
        } catch (e) {
          showToast('設定更新失敗', 'error');
        }
      };

      if (loading) return <div className="flex justify-center h-64"><Spinner size="lg" /></div>;

      return (
        <div className="space-y-6 animate-fade-in">
          <div><h2 className="text-2xl font-bold">設定</h2><p className="text-[var(--text-muted)] mt-1">サーバー設定と接続情報</p></div>

          {/* Cloudflare Tunnel */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4 flex items-center gap-2">
              <svg className="w-5 h-5 text-orange-500" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12.5c.5.5.5 1.5 0 2l-3 3c-.5.5-1.5.5-2 0l-3-3c-.5-.5-.5-1.5 0-2l3-3c.5-.5 1.5-.5 2 0l3 3zM12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/></svg>
              Cloudflare Tunnel
            </h3>
            <div className="space-y-4">
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <div>
                  <span className="text-[var(--text-secondary)]">状態</span>
                  <p className="text-sm text-[var(--text-muted)] mt-1">サーバーを外部に公開</p>
                </div>
                <div className="flex items-center gap-3">
                  <span className={`status-dot ${tunnel.active ? 'status-online' : 'status-offline'}`} />
                  <span className={tunnel.active ? 'text-green-500' : 'text-[var(--text-muted)]'}>
                    {tunnel.active ? '接続中' : '未接続'}
                  </span>
                </div>
              </div>
              
              {tunnel.active && tunnel.url && (
                <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                  <p className="text-sm text-green-600 mb-2">公開URL</p>
                  <div className="flex items-center gap-2">
                    <code className="flex-1 bg-[var(--bg-secondary)] px-3 py-2 rounded-lg text-sm break-all">{tunnel.url}</code>
                    <button onClick={() => copyUrl(tunnel.url)} className={`px-3 py-2 rounded-lg text-sm font-medium ${copied ? 'bg-green-500 text-white' : 'btn-secondary'}`}>
                      {copied ? '✓' : 'コピー'}
                    </button>
                    <button onClick={() => window.electronAPI?.openExternal(tunnel.url)} className="btn-secondary px-3 py-2 text-sm">開く</button>
                  </div>
                  <div className="mt-3 flex gap-2">
                    <button onClick={() => window.electronAPI?.openExternal(`${tunnel.url}/docs`)} className="text-sm text-indigo-500 hover:underline bg-transparent border-none cursor-pointer p-0">📖 Swagger UI</button>
                    <span className="text-[var(--text-muted)]">|</span>
                    <button onClick={() => window.electronAPI?.openExternal(`${tunnel.url}/admin`)} className="text-sm text-indigo-500 hover:underline bg-transparent border-none cursor-pointer p-0">⚙️ 管理画面</button>
                  </div>
                </div>
              )}
              
              <div className="flex gap-3 items-center">
                {tunnelInstalled === null ? (
                  <span className="text-sm text-[var(--text-muted)] flex items-center gap-2">
                    <Spinner size="sm" /> cloudflared確認中...
                  </span>
                ) : tunnelInstalled === false ? (
                  <button onClick={handleTunnelInstall} disabled={tunnelInstalling} className="btn-primary flex items-center gap-2 px-4 py-2 disabled:opacity-50">
                    {tunnelInstalling ? <Spinner size="sm" /> : '⬇'}
                    {tunnelInstalling ? 'インストール中...' : 'cloudflaredをインストール'}
                  </button>
                ) : tunnel.active ? (
                  <button onClick={handleTunnelStop} className="btn-danger flex items-center gap-2 px-4 py-2">
                    ⏹ トンネル停止
                  </button>
                ) : (
                  <button onClick={handleTunnelStart} disabled={tunnelLoading} className="btn-primary flex items-center gap-2 px-4 py-2 disabled:opacity-50">
                    {tunnelLoading ? <Spinner size="sm" /> : '▶'}
                    {tunnelLoading ? '接続中...' : 'トンネル開始'}
                  </button>
                )}
              </div>
              {tunnelInstalled === false && !tunnelInstalling && (
                <p className="text-xs text-[var(--text-muted)]">
                  ※ Cloudflare Tunnelを使用するにはcloudflaredのインストールが必要です
                </p>
              )}

              {/* Custom Domain Settings */}
              <div className="mt-6 pt-4 border-t border-[var(--border)]">
                <h4 className="text-sm font-medium mb-3">カスタムドメイン設定（オプション）</h4>
                <p className="text-xs text-[var(--text-muted)] mb-4">
                  Cloudflare Zero TrustでNamed Tunnelを作成しトークンを設定すると、カスタムドメインを使用できます。
                  空欄の場合はランダムURL（trycloudflare.com）が使用されます。
                </p>
                <div className="space-y-3">
                  <div>
                    <label className="block text-xs font-medium mb-1 text-[var(--text-secondary)]">トンネルトークン</label>
                    <input
                      type="password"
                      value={config?.tunnelToken || ''}
                      onChange={(e) => handleConfigChange('tunnelToken', e.target.value)}
                      placeholder="eyJhIjoixxxxxxx..."
                      className="input-field text-sm"
                    />
                    <p className="text-xs text-[var(--text-muted)] mt-1">
                      Cloudflare Zero Trust → Access → Tunnels で取得
                    </p>
                  </div>
                  <div>
                    <label className="block text-xs font-medium mb-1 text-[var(--text-secondary)]">カスタムURL</label>
                    <input
                      type="url"
                      value={config?.tunnelCustomUrl || ''}
                      onChange={(e) => handleConfigChange('tunnelCustomUrl', e.target.value)}
                      placeholder="https://api.example.com"
                      className="input-field text-sm"
                    />
                    <p className="text-xs text-[var(--text-muted)] mt-1">
                      トンネルに設定したホスト名（Public Hostname）
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* API Documentation */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4">📖 APIドキュメント</h3>
            <div className="space-y-4">
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <div>
                  <span className="text-[var(--text-secondary)]">Swagger UI</span>
                  <p className="text-sm text-[var(--text-muted)] mt-1">インタラクティブなAPI仕様書</p>
                </div>
                <a href={`${serverUrl}/docs`} target="_blank" rel="noopener noreferrer" className="btn-primary px-4 py-2 text-sm">
                  開く →
                </a>
              </div>
              <div className="flex items-center justify-between py-3">
                <div>
                  <span className="text-[var(--text-secondary)]">OpenAPI Spec</span>
                  <p className="text-sm text-[var(--text-muted)] mt-1">JSON形式のAPI仕様</p>
                </div>
                <a href={`${serverUrl}/openapi.json`} target="_blank" rel="noopener noreferrer" className="btn-secondary px-4 py-2 text-sm">
                  JSON →
                </a>
              </div>
            </div>
          </div>

          {/* Server Control */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4 flex items-center gap-2">
              <svg className="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h14M12 5l7 7-7 7" />
              </svg>
              サーバー制御
            </h3>
            <div className="space-y-4">
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <div>
                  <span className="text-[var(--text-secondary)]">サーバー状態</span>
                  <p className="text-sm text-[var(--text-muted)] mt-1">API サーバーの起動状態</p>
                </div>
                <div className="flex items-center gap-2">
                  <span className={`status-dot ${health?.status === 'ok' ? 'status-online' : 'status-offline'}`} />
                  <span className={health?.status === 'ok' ? 'text-green-500' : 'text-red-500'}>
                    {health?.status === 'ok' ? 'オンライン' : 'オフライン'}
                  </span>
                </div>
              </div>

              {/* Port conflict warning */}
              {portConflict && (
                <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                  <p className="text-sm text-red-600 mb-2">⚠️ ポート競合を検出</p>
                  <p className="text-sm text-[var(--text-secondary)]">
                    ポート {portConflict.port} は別のプロセスによって使用されています：
                  </p>
                  <code className="block mt-2 bg-[var(--bg-secondary)] px-3 py-2 rounded-lg text-sm">
                    PID: {portConflict.pid} | {portConflict.command} ({portConflict.user})
                  </code>
                  <button
                    onClick={handleKillConflictProcess}
                    className="btn-danger mt-3 px-4 py-2 text-sm"
                  >
                    このプロセスを終了して起動
                  </button>
                </div>
              )}

              <div className="flex gap-3">
                {health?.status === 'ok' ? (
                  <>
                    <button
                      onClick={handleServerStop}
                      disabled={serverLoading}
                      className="btn-danger flex items-center gap-2 px-4 py-2 disabled:opacity-50"
                    >
                      {serverLoading ? <Spinner size="sm" /> : '⏹'}
                      停止
                    </button>
                    <button
                      onClick={handleServerRestart}
                      disabled={serverLoading}
                      className="btn-secondary flex items-center gap-2 px-4 py-2 disabled:opacity-50"
                    >
                      {serverLoading ? <Spinner size="sm" /> : '🔄'}
                      再起動
                    </button>
                  </>
                ) : (
                  <button
                    onClick={handleServerStart}
                    disabled={serverLoading}
                    className="btn-primary flex items-center gap-2 px-4 py-2 disabled:opacity-50"
                  >
                    {serverLoading ? <Spinner size="sm" /> : '▶'}
                    起動
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* Appearance */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4">外観</h3>
            <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
              <div className="flex items-center gap-3">
                {dark ? <Icons.Moon /> : <Icons.Sun />}
                <span>ダークモード</span>
              </div>
              <button onClick={toggle} className={`toggle-switch ${dark ? 'active' : ''}`} />
            </div>
            <div className="flex items-center justify-between py-3">
              <div>
                <span className="text-[var(--text-secondary)]">終了時にサーバーを停止</span>
                <p className="text-sm text-[var(--text-muted)] mt-1">アプリを閉じたときにサーバーも停止する</p>
              </div>
              <button onClick={() => handleKillOnCloseToggle(!killOnClose)} className={`toggle-switch ${killOnClose ? 'active' : ''}`} />
            </div>
          </div>

          {/* Server Settings */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4">サーバー設定</h3>
            <div className="space-y-4">
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <div>
                  <span className="text-[var(--text-secondary)]">ポート番号</span>
                  <p className="text-sm text-[var(--text-muted)] mt-1">変更は再起動後に適用</p>
                </div>
                <div className="flex items-center gap-2">
                  <input
                    type="number"
                    value={portInput}
                    onChange={e => setPortInput(e.target.value)}
                    className="input-field w-24 text-center"
                    min="1"
                    max="65535"
                  />
                  <button onClick={handlePortSave} className="btn-secondary px-3 py-2 text-sm">保存</button>
                </div>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">現在のURL</span>
                <code className="bg-[var(--bg-tertiary)] px-3 py-1 rounded-lg text-sm">{serverUrl}</code>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">サーバー状態</span>
                <div className="flex items-center gap-2">
                  <span className={`status-dot ${health?.status === 'ok' ? 'status-online' : 'status-offline'}`} />
                  <span className={health?.status === 'ok' ? 'text-green-500' : 'text-red-500'}>
                    {health?.status === 'ok' ? 'オンライン' : 'オフライン'}
                  </span>
                </div>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">デフォルトモデル</span>
                <select
                  value={health?.config?.defaultModel || ''}
                  onChange={(e) => handleModelChange(e.target.value)}
                  className="input-field w-auto min-w-[200px]"
                >
                  <optgroup label="OpenAI / Codex">
                    {models.filter(m => m.provider === 'codex').map(m => (
                      <option key={m.id} value={m.id}>{m.id}</option>
                    ))}
                  </optgroup>
                  <optgroup label="Anthropic / Claude">
                    {models.filter(m => m.provider === 'claude').map(m => (
                      <option key={m.id} value={m.id}>{m.id}</option>
                    ))}
                  </optgroup>
                </select>
              </div>
              <div className="flex items-center justify-between py-3">
                <span className="text-[var(--text-secondary)]">デバッグモード</span>
                <span className={health?.config?.debug ? 'text-orange-500' : ''}>{health?.config?.debug ? '有効' : '無効'}</span>
              </div>
            </div>
          </div>

          {/* Notifications */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4">通知設定</h3>
            <div className="space-y-4">
              {[
                { key: 'rateLimit', label: 'レート制限警告', desc: 'APIキーがレート制限に近づいたとき' },
                { key: 'expiration', label: '有効期限アラート', desc: 'APIキーの有効期限が近づいたとき' },
                { key: 'errors', label: 'エラー通知', desc: 'APIエラーが発生したとき' },
              ].map(n => (
                <div key={n.key} className="flex items-center justify-between py-3 border-b border-[var(--border)] last:border-0">
                  <div>
                    <p className="font-medium">{n.label}</p>
                    <p className="text-sm text-[var(--text-muted)]">{n.desc}</p>
                  </div>
                  <button onClick={() => setNotifications(p => ({ ...p, [n.key]: !p[n.key] }))} className={`toggle-switch ${notifications[n.key] ? 'active' : ''}`} />
                </div>
              ))}
            </div>
          </div>

          {/* Codex CLI */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4">Codex CLI</h3>
            <div className="space-y-4">
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">インストール</span>
                <span className={health?.codex?.installed ? 'text-green-500' : 'text-red-500'}>
                  {health?.codex?.installed ? '✓ インストール済み' : '✗ 未インストール'}
                </span>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">認証状態</span>
                <span className={health?.codex?.authenticated ? 'text-green-500' : 'text-red-500'}>
                  {health?.codex?.authenticated ? '✓ 認証済み' : '✗ 未認証'}
                </span>
              </div>
              <div className="flex items-center justify-between py-3">
                <span className="text-[var(--text-secondary)]">認証方法</span>
                <span>{health?.codex?.authMethod === 'chatgpt' ? 'ChatGPTアカウント' : health?.codex?.authMethod === 'api_key' ? 'APIキー' : '-'}</span>
              </div>
            </div>
          </div>

          {/* Claude Code */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4">Claude Code</h3>
            <div className="space-y-4">
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">インストール</span>
                <span className={health?.claude?.installed ? 'text-green-500' : 'text-red-500'}>
                  {health?.claude?.installed ? '✓ インストール済み' : '✗ 未インストール'}
                </span>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">バージョン</span>
                <code className="bg-[var(--bg-tertiary)] px-3 py-1 rounded-lg text-sm">{health?.claude?.version || '-'}</code>
              </div>
              <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
                <span className="text-[var(--text-secondary)]">認証状態</span>
                <span className={health?.claude?.authenticated ? 'text-green-500' : 'text-red-500'}>
                  {health?.claude?.authenticated ? '✓ 認証済み' : '✗ 未認証'}
                </span>
              </div>
              <div className="flex items-center justify-between py-3">
                <span className="text-[var(--text-secondary)]">認証方法</span>
                <span>{health?.claude?.authMethod === 'api_key' ? 'APIキー' : health?.claude?.authMethod === 'subscription' ? 'サブスクリプション' : '-'}</span>
              </div>
            </div>
          </div>

          {/* Storage */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4">ストレージ</h3>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-[var(--bg-tertiary)] rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-indigo-500">{formatNum(health?.storage?.totalResponses)}</p>
                <p className="text-sm text-[var(--text-muted)] mt-1">レスポンス</p>
              </div>
              <div className="bg-[var(--bg-tertiary)] rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-purple-500">{formatNum(health?.storage?.totalConversations)}</p>
                <p className="text-sm text-[var(--text-muted)] mt-1">会話</p>
              </div>
              <div className="bg-[var(--bg-tertiary)] rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-pink-500">{formatNum(health?.storage?.totalInputItems)}</p>
                <p className="text-sm text-[var(--text-muted)] mt-1">入力アイテム</p>
              </div>
              <div className="bg-[var(--bg-tertiary)] rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-orange-500">{formatNum(health?.storage?.backgroundJobs)}</p>
                <p className="text-sm text-[var(--text-muted)] mt-1">バックグラウンドジョブ</p>
              </div>
            </div>
          </div>

          {/* Auto Update */}
          <UpdateSettingsSection showToast={showToast} />

          {/* System */}
          <div className="card p-6">
            <h3 className="font-semibold mb-4 flex items-center gap-2">
              <Icons.Settings />
              システム
            </h3>
            <div className="space-y-4">
              <div className="flex items-center justify-between py-3">
                <div>
                  <span className="font-medium">セットアップウィザード</span>
                  <p className="text-sm text-[var(--text-muted)] mt-1">初期設定をもう一度やり直す</p>
                </div>
                <button
                  onClick={() => {
                    if (window.electronAPI && confirm('セットアップウィザードを開始しますか？')) {
                      window.electronAPI.resetOnboarding();
                    }
                  }}
                  className="btn-secondary px-4 py-2"
                >
                  再開する
                </button>
              </div>
            </div>
          </div>

          {/* Advanced Settings */}
          <div className="card p-6">
            <button
              onClick={() => setAdvancedOpen(!advancedOpen)}
              className="w-full flex items-center justify-between font-semibold"
            >
              <span className="flex items-center gap-2">
                <svg className="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                詳細設定
              </span>
              <svg className={`w-5 h-5 transition-transform ${advancedOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            {advancedOpen && (
              <div className="mt-4 pt-4 border-t border-[var(--border)] space-y-4">
                <p className="text-sm text-[var(--text-muted)]">
                  CLIツールのカスタムパスを設定できます。空欄の場合はデフォルトのパスが使用されます。
                </p>

                {[
                  { key: 'npm', configKey: 'customNpmPath', label: 'npm', placeholder: '/usr/local/bin/npm' },
                  { key: 'claude', configKey: 'customClaudePath', label: 'Claude Code', placeholder: '/usr/local/bin/claude' },
                  { key: 'codex', configKey: 'customCodexPath', label: 'Codex CLI', placeholder: '/usr/local/bin/codex' },
                  { key: 'cloudflared', configKey: 'customCloudflaredPath', label: 'cloudflared', placeholder: '/usr/local/bin/cloudflared' },
                ].map(item => (
                  <div key={item.key} className="space-y-2">
                    <label className="text-sm font-medium text-[var(--text-secondary)]">{item.label} パス</label>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={customPaths[item.key]}
                        onChange={(e) => setCustomPaths(prev => ({ ...prev, [item.key]: e.target.value }))}
                        placeholder={item.placeholder}
                        className="input-field flex-1"
                      />
                      <button
                        onClick={() => handleCustomPathSave(item.key, item.configKey, customPaths[item.key])}
                        className="btn-secondary px-3 py-2 text-sm"
                      >
                        保存
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    // ============================================
    // Update Settings Section
    // ============================================
    const UpdateSettingsSection = ({ showToast }) => {
      const [updateConfig, setUpdateConfig] = useState({
        updateEnabled: true,
        updateCheckOnStartup: true,
        updateNotifyOnStartup: true,
        updateAutoDownload: false,
      });
      const [updateStatus, setUpdateStatus] = useState(null);
      const [checking, setChecking] = useState(false);

      useEffect(() => {
        if (window.electronAPI) {
          window.electronAPI.getConfig().then(config => {
            setUpdateConfig({
              updateEnabled: config.updateEnabled ?? true,
              updateCheckOnStartup: config.updateCheckOnStartup ?? true,
              updateNotifyOnStartup: config.updateNotifyOnStartup ?? true,
              updateAutoDownload: config.updateAutoDownload ?? false,
            });
          });
          window.electronAPI.getUpdateStatus().then(setUpdateStatus);
          window.electronAPI.onUpdateStatus(setUpdateStatus);
        }
      }, []);

      const handleToggle = async (key) => {
        const newValue = !updateConfig[key];
        setUpdateConfig(prev => ({ ...prev, [key]: newValue }));
        if (window.electronAPI) {
          await window.electronAPI.setConfig(key, newValue);
        }
      };

      const handleCheckUpdate = async () => {
        if (!window.electronAPI) return;
        setChecking(true);
        try {
          const result = await window.electronAPI.checkForUpdates();
          setUpdateStatus(result);
          if (result.available) {
            showToast('新しいバージョンが見つかりました', 'success');
          } else {
            showToast('最新バージョンです', 'info');
          }
        } catch (e) {
          showToast('更新チェックに失敗しました', 'error');
        } finally {
          setChecking(false);
        }
      };

      if (!window.electronAPI) return null;

      return (
        <div className="card p-6">
          <h3 className="font-semibold mb-4 flex items-center gap-2">
            <Icons.Update />
            自動アップデート
          </h3>
          <div className="space-y-4">
            <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
              <div>
                <span className="text-[var(--text-secondary)]">現在のバージョン</span>
              </div>
              <code className="bg-[var(--bg-tertiary)] px-3 py-1 rounded-lg text-sm">
                {updateStatus?.currentVersion || '-'}
              </code>
            </div>

            <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
              <div>
                <p className="font-medium">自動更新を有効にする</p>
                <p className="text-sm text-[var(--text-muted)]">GitHubから自動的に更新をチェック</p>
              </div>
              <button
                onClick={() => handleToggle('updateEnabled')}
                className={`toggle-switch ${updateConfig.updateEnabled ? 'active' : ''}`}
              />
            </div>

            <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
              <div>
                <p className="font-medium">起動時に更新をチェック</p>
                <p className="text-sm text-[var(--text-muted)]">アプリ起動時に新しいバージョンを確認</p>
              </div>
              <button
                onClick={() => handleToggle('updateCheckOnStartup')}
                className={`toggle-switch ${updateConfig.updateCheckOnStartup ? 'active' : ''}`}
                disabled={!updateConfig.updateEnabled}
              />
            </div>

            <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
              <div>
                <p className="font-medium">更新通知を表示</p>
                <p className="text-sm text-[var(--text-muted)]">新しいバージョンがある場合にダイアログを表示</p>
              </div>
              <button
                onClick={() => handleToggle('updateNotifyOnStartup')}
                className={`toggle-switch ${updateConfig.updateNotifyOnStartup ? 'active' : ''}`}
                disabled={!updateConfig.updateEnabled}
              />
            </div>

            <div className="flex items-center justify-between py-3 border-b border-[var(--border)]">
              <div>
                <p className="font-medium">自動ダウンロード</p>
                <p className="text-sm text-[var(--text-muted)]">更新を自動的にダウンロード</p>
              </div>
              <button
                onClick={() => handleToggle('updateAutoDownload')}
                className={`toggle-switch ${updateConfig.updateAutoDownload ? 'active' : ''}`}
                disabled={!updateConfig.updateEnabled}
              />
            </div>

            <div className="pt-2">
              <button
                onClick={handleCheckUpdate}
                disabled={checking || !updateConfig.updateEnabled}
                className="btn-primary px-4 py-2 flex items-center gap-2"
              >
                {checking ? <Spinner size="sm" /> : <Icons.Refresh />}
                {checking ? 'チェック中...' : '今すぐ更新を確認'}
              </button>
              {updateStatus?.available && (
                <div className="mt-3 bg-green-50 border border-green-200 rounded-lg p-3">
                  <p className="text-green-700 text-sm">
                    新しいバージョン {updateStatus.updateInfo?.version} が利用可能です
                  </p>
                </div>
              )}
              {updateStatus?.downloaded && (
                <div className="mt-3 bg-indigo-50 border border-indigo-200 rounded-lg p-3 flex items-center justify-between">
                  <p className="text-indigo-700 text-sm">
                    更新がダウンロード済みです。再起動後に適用されます。
                  </p>
                  <button
                    onClick={() => window.electronAPI.installUpdate()}
                    className="btn-success px-3 py-1 text-sm"
                  >
                    今すぐ再起動
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Login Page
    // ============================================
    const LoginPage = ({ onLogin }) => {
      const [serverUrl, setServerUrl] = useState('');
      const [masterKey, setMasterKey] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [autoLogging, setAutoLogging] = useState(true);
      const { dark, toggle } = useTheme();

      // Auto-fill from Electron config
      useEffect(() => {
        const loadConfig = async () => {
          try {
            if (window.electronAPI) {
              const url = await window.electronAPI.getServerUrl();
              const key = await window.electronAPI.getMasterKey();
              setServerUrl(url || 'http://localhost:8080');
              setMasterKey(key || '');

              // Auto-login for local access
              if (url && key) {
                const api = createApi(url, key);
                await api.health();
                onLogin(url, key);
                return;
              }
            } else {
              setServerUrl(window.location.origin !== 'file://' ? window.location.origin : 'http://localhost:8080');
            }
          } catch (err) {
            // Failed to auto-login, show login form
          }
          setAutoLogging(false);
        };
        loadConfig();
      }, [onLogin]);

      const submit = async (e) => {
        e.preventDefault(); setError(''); setLoading(true);
        try { const api = createApi(serverUrl, masterKey); await api.health(); await api.getStats(); onLogin(serverUrl, masterKey); }
        catch (err) { setError('接続に失敗しました。URLとキーを確認してください。'); }
        finally { setLoading(false); }
      };

      if (autoLogging) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <Spinner size="lg" />
              <p className="mt-4 text-[var(--text-muted)]">接続中...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="card w-full max-w-sm p-6">
            <div className="mb-6">
              <h1 className="text-lg font-semibold" style={{letterSpacing: '-0.3px'}}>Codex ClaudeCode API Server</h1>
              <p className="text-[var(--text-muted)] text-sm mt-1">管理コンソールにログイン</p>
            </div>
            <form onSubmit={submit} className="space-y-4">
              <div>
                <label className="block text-xs font-medium mb-1.5 text-[var(--text-secondary)]">サーバーURL</label>
                <input type="url" value={serverUrl} onChange={e => setServerUrl(e.target.value)} placeholder="http://localhost:8080" className="input-field" required />
              </div>
              <div>
                <label className="block text-xs font-medium mb-1.5 text-[var(--text-secondary)]">マスターキー</label>
                <input type="password" value={masterKey} onChange={e => setMasterKey(e.target.value)} placeholder="MASTER_KEY の値" className="input-field" required />
              </div>
              {error && <div className="text-[var(--danger)] text-xs p-3 bg-[#fee2e2] rounded">{error}</div>}
              <button type="submit" disabled={loading} className="w-full btn btn-primary py-2.5 flex items-center justify-center gap-2">{loading ? <><Spinner size="sm" />接続中...</> : 'ログイン'}</button>
            </form>
          </div>
        </div>
      );
    };

    // ============================================
    // Update Dialog
    // ============================================
    const UpdateDialog = ({ updateInfo, updateStatus, onDownload, onInstall, onClose }) => {
      const [dmgDownloading, setDmgDownloading] = useState(false);
      const [dmgDownloaded, setDmgDownloaded] = useState(false);
      const [dmgError, setDmgError] = useState(null);

      const formatBytes = (bytes) => {
        if (!bytes) return '';
        const mb = bytes / (1024 * 1024);
        return `${mb.toFixed(1)} MB`;
      };

      const isMac = navigator.platform.toLowerCase().includes('mac');
      const dmgUrl = updateInfo?.version
        ? `https://github.com/DaisukeHori/codex_cc_openai_server/releases/download/v${updateInfo.version}/CodexAPIServer-${updateInfo.version}-arm64.dmg`
        : null;

      const handleDMGDownload = async () => {
        if (!dmgUrl || !window.electronAPI) return;
        setDmgDownloading(true);
        setDmgError(null);
        try {
          const result = await window.electronAPI.downloadDMG(dmgUrl);
          if (result.success) {
            setDmgDownloaded(true);
          } else {
            setDmgError(result.error || 'ダウンロードに失敗しました');
          }
        } catch (e) {
          setDmgError(e.message || 'ダウンロードに失敗しました');
        } finally {
          setDmgDownloading(false);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex items-center gap-3 mb-4">
                <div className="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center">
                  <Icons.Update />
                </div>
                <div>
                  <h3 className="font-semibold text-lg">アップデートが利用可能</h3>
                  <p className="text-sm text-[var(--text-muted)]">新しいバージョンがあります</p>
                </div>
              </div>

              <div className="bg-[var(--bg-tertiary)] rounded-lg p-4 mb-4">
                <div className="flex justify-between items-center mb-2">
                  <span className="text-[var(--text-secondary)]">現在のバージョン</span>
                  <code className="bg-[var(--bg-secondary)] px-2 py-1 rounded text-sm">{updateStatus?.currentVersion}</code>
                </div>
                <div className="flex justify-between items-center">
                  <span className="text-[var(--text-secondary)]">新しいバージョン</span>
                  <code className="bg-green-100 text-green-700 px-2 py-1 rounded text-sm">{updateInfo?.version}</code>
                </div>
              </div>

              {updateInfo?.releaseNotes && (
                <div className="mb-4">
                  <h4 className="font-medium mb-2">リリースノート</h4>
                  <div
                    className="bg-[var(--bg-tertiary)] rounded-lg p-3 text-sm text-[var(--text-secondary)] max-h-32 overflow-y-auto scrollbar-thin release-notes-content"
                    dangerouslySetInnerHTML={{ __html: updateInfo.releaseNotes }}
                  />
                </div>
              )}

              {updateStatus?.downloading && (
                <div className="mb-4">
                  <div className="flex justify-between text-sm mb-1">
                    <span>ダウンロード中...</span>
                    <span>{updateStatus.progress?.percent?.toFixed(0) || 0}%</span>
                  </div>
                  <div className="progress-bar">
                    <div className="progress-bar-fill" style={{ width: `${updateStatus.progress?.percent || 0}%` }} />
                  </div>
                  <p className="text-xs text-[var(--text-muted)] mt-1">
                    {formatBytes(updateStatus.progress?.transferred)} / {formatBytes(updateStatus.progress?.total)}
                  </p>
                </div>
              )}

              {updateStatus?.error && (
                <div className="bg-red-50 text-red-600 rounded-lg p-3 mb-4 text-sm">
                  エラー: {updateStatus.error}
                </div>
              )}

              {dmgError && (
                <div className="bg-red-50 text-red-600 rounded-lg p-3 mb-4 text-sm">
                  エラー: {dmgError}
                </div>
              )}

              <div className="flex gap-3">
                {isMac ? (
                  dmgDownloaded ? (
                    <button onClick={onClose} className="flex-1 btn-success py-3 flex items-center justify-center gap-2">
                      ダウンロード完了（Finderで開きました）
                    </button>
                  ) : dmgDownloading ? (
                    <button disabled className="flex-1 btn-primary py-3 opacity-50 cursor-not-allowed flex items-center justify-center gap-2">
                      <Spinner size="sm" />
                      ダウンロード中...
                    </button>
                  ) : (
                    <button onClick={handleDMGDownload} className="flex-1 btn-primary py-3 flex items-center justify-center gap-2">
                      <Icons.Download />
                      DMGをダウンロード
                    </button>
                  )
                ) : updateStatus?.downloaded ? (
                  <button onClick={onInstall} className="flex-1 btn-success py-3 flex items-center justify-center gap-2">
                    再起動して更新
                  </button>
                ) : updateStatus?.downloading ? (
                  <button disabled className="flex-1 btn-primary py-3 opacity-50 cursor-not-allowed flex items-center justify-center gap-2">
                    <Spinner size="sm" />
                    ダウンロード中...
                  </button>
                ) : (
                  <button onClick={onDownload} className="flex-1 btn-primary py-3 flex items-center justify-center gap-2">
                    <Icons.Download />
                    ダウンロード
                  </button>
                )}
                <button onClick={onClose} className="btn-secondary py-3 px-6">
                  後で
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // Main Layout
    // ============================================
    const MainLayout = ({ serverUrl, onLogout }) => {
      const [page, setPage] = useState('dashboard');
      const [toast, setToast] = useState(null);
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [notifications, setNotifications] = useState([]);
      const [showUpdateDialog, setShowUpdateDialog] = useState(false);
      const [updateStatus, setUpdateStatus] = useState(null);
      const [updateInfo, setUpdateInfo] = useState(null);
      const { dark, toggle } = useTheme();

      const api = useMemo(() => createApi(serverUrl), [serverUrl]);
      const showToast = useCallback((msg, type = 'info') => setToast({ message: msg, type }), []);

      // Listen for update events from Electron
      useEffect(() => {
        if (window.electronAPI) {
          window.electronAPI.onUpdateAvailable((info) => {
            setUpdateInfo(info);
            setShowUpdateDialog(true);
          });
          window.electronAPI.onUpdateStatus((status) => {
            setUpdateStatus(status);
          });
          window.electronAPI.onUpdateDownloaded((info) => {
            setUpdateInfo(info);
            showToast('アップデートのダウンロードが完了しました', 'success');
          });

          // Get initial update status
          window.electronAPI.getUpdateStatus().then(setUpdateStatus);
        }
      }, [showToast]);

      const handleDownloadUpdate = async () => {
        try {
          await window.electronAPI.downloadUpdate();
        } catch (e) {
          showToast('ダウンロードに失敗しました', 'error');
        }
      };

      const handleInstallUpdate = () => {
        window.electronAPI.installUpdate();
      };

      // Simulate notifications
      useEffect(() => {
        const interval = setInterval(() => {
          if (Math.random() > 0.8) {
            setNotifications(n => [...n.slice(-4), { id: Date.now(), message: 'APIキー xxx のレート制限に近づいています', type: 'warning' }]);
          }
        }, 10000);
        return () => clearInterval(interval);
      }, []);

      const nav = [
        { id: 'dashboard', icon: <Icons.Dashboard />, label: 'ダッシュボード' },
        { id: 'apikeys', icon: <Icons.Key />, label: 'APIキー' },
        { id: 'responses', icon: <Icons.History />, label: '履歴' },
        { id: 'playground', icon: <Icons.Terminal />, label: 'Playground' },
        { id: 'logs', icon: <Icons.Log />, label: 'ログ' },
        { id: 'settings', icon: <Icons.Settings />, label: '設定' },
      ];

      const renderPage = () => {
        switch (page) {
          case 'dashboard': return <DashboardPage api={api} showToast={showToast} />;
          case 'apikeys': return <ApiKeysPage api={api} showToast={showToast} />;
          case 'responses': return <ResponsesPage api={api} showToast={showToast} />;
          case 'playground': return <PlaygroundPage api={api} showToast={showToast} />;
          case 'logs': return <LogsPage api={api} showToast={showToast} />;
          case 'settings': return <SettingsPage api={api} serverUrl={serverUrl} showToast={showToast} />;
          default: return <DashboardPage api={api} showToast={showToast} />;
        }
      };

      return (
        <div className="flex min-h-screen">
          {/* Mobile menu button */}
          <button onClick={() => setSidebarOpen(!sidebarOpen)} className="md:hidden fixed top-4 left-4 z-50 p-2 rounded-lg bg-[var(--bg-secondary)] shadow-lg">
            <Icons.Menu />
          </button>

          {/* Sidebar */}
          <aside className={`sidebar w-56 flex flex-col fixed md:sticky md:top-0 inset-y-0 left-0 z-40 transition-transform duration-200 h-screen overflow-hidden ${sidebarOpen ? '' : '-translate-x-full md:translate-x-0'}`}>
            <div className="p-6 pb-4 flex-shrink-0">
              <div className="text-sm font-semibold text-[var(--text-primary)]" style={{letterSpacing: '-0.3px'}}>Codex ClaudeCode API Server</div>
            </div>
            <nav className="flex-1 overflow-y-auto">
              {nav.map(n => (
                <button key={n.id} onClick={() => { setPage(n.id); setSidebarOpen(false); }} className={`sidebar-item w-full text-left ${page === n.id ? 'active' : ''}`}>
                  {n.icon}<span>{n.label}</span>
                </button>
              ))}
            </nav>
            <div className="p-4 border-t border-[var(--border)] flex-shrink-0">
              <button onClick={onLogout} className="sidebar-item w-full text-left">
                <Icons.Logout /><span>ログアウト</span>
              </button>
            </div>
          </aside>

          {/* Main Content */}
          <main className="flex-1 md:ml-0">
            {/* Top Bar */}
            <header className="sticky top-0 z-30 bg-[var(--bg-primary)]/80 backdrop-blur border-b border-[var(--border)] px-4 md:px-8 py-4">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-semibold ml-12 md:ml-0">{nav.find(n => n.id === page)?.label}</h2>
                <div className="flex items-center gap-4">
                  {/* Notifications */}
                  <div className="relative group">
                    <button className="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] relative">
                      <Icons.Bell />
                      {notifications.length > 0 && <span className="notification-badge">{notifications.length}</span>}
                    </button>
                    {notifications.length > 0 && (
                      <div className="absolute right-0 mt-2 w-80 card p-2 hidden group-hover:block">
                        {notifications.map(n => (
                          <div key={n.id} className="px-3 py-2 text-sm rounded hover:bg-[var(--bg-tertiary)]">
                            <p className="text-[var(--text-secondary)]">{n.message}</p>
                          </div>
                        ))}
                        <button onClick={() => setNotifications([])} className="w-full text-center text-sm text-indigo-500 py-2 hover:bg-[var(--bg-tertiary)] rounded">すべてクリア</button>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </header>

            <div className="p-4 md:p-8">{renderPage()}</div>
          </main>

          {/* Toast */}
          {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

          {/* Update Dialog */}
          {showUpdateDialog && (
            <UpdateDialog
              updateInfo={updateInfo}
              updateStatus={updateStatus}
              onDownload={handleDownloadUpdate}
              onInstall={handleInstallUpdate}
              onClose={() => setShowUpdateDialog(false)}
            />
          )}

          {/* Mobile overlay */}
          {sidebarOpen && <div className="md:hidden fixed inset-0 bg-black/50 z-30" onClick={() => setSidebarOpen(false)} />}
        </div>
      );
    };

    // ============================================
    // App (No login required for local app)
    // ============================================
    const App = () => {
      const [serverUrl, setServerUrl] = useState('http://localhost:8080');
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const init = async () => {
          try {
            if (window.electronAPI) {
              const url = await window.electronAPI.getServerUrl();
              if (url) setServerUrl(url);
            }
          } catch (e) {
            console.error('Failed to get server URL:', e);
          } finally {
            setLoading(false);
          }
        };
        init();
      }, []);

      if (loading) {
        return (
          <ThemeProvider>
            <div className="min-h-screen flex items-center justify-center">
              <Spinner size="lg" />
            </div>
          </ThemeProvider>
        );
      }

      return (
        <ThemeProvider>
          <MainLayout serverUrl={serverUrl} onLogout={() => window.electronAPI?.closeWindow()} />
        </ThemeProvider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
